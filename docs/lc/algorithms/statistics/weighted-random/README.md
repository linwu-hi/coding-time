# åŠ æƒéšæœº

![Weighted Random](images/cover.png)

## ä»€ä¹ˆæ˜¯"åŠ æƒéšæœº"

å‡è®¾ä½ æœ‰ä¸€ä¸ª**é¡¹ç›®åˆ—è¡¨**ã€‚é¡¹ç›®å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸€ä¸ªå–œæ¬¢åƒçš„æ°´æœå’Œè”¬èœåˆ—è¡¨ï¼š`[ 'ğŸŒ', 'ğŸ', 'ğŸ¥•' ]`ã€‚

**æƒé‡åˆ—è¡¨**è¡¨ç¤ºæ¯ä¸ªé¡¹ç›®çš„æƒé‡ï¼ˆæˆ–æ¦‚ç‡ã€é‡è¦æ€§ï¼‰ã€‚æƒé‡æ˜¯æ•°å­—ã€‚ä¾‹å¦‚ï¼Œæƒé‡åˆ—è¡¨ `[3, 7, 1]` å¯ä»¥è¡¨ç¤ºï¼š

- ä½ æ›´å–œæ¬¢åƒ`ğŸè‹¹æœ`ï¼ˆ`7`æ¬¡ä¸­çš„`3`æ¬¡+`7`æ¬¡+`1`æ¬¡ä¸­çš„`11`æ¬¡ï¼‰ï¼Œ
- ç„¶åä½ ä¸å¤ªå–œæ¬¢åƒé¦™è•‰`ğŸŒ`ï¼ˆåªæœ‰`11`æ¬¡ä¸­çš„`3`æ¬¡ï¼‰ï¼Œ
- è€Œä½ çœŸçš„ä¸å–œæ¬¢èƒ¡èåœ`ğŸ¥•`ï¼ˆåªæƒ³åƒ`11`æ¬¡ä¸­çš„`1`æ¬¡ï¼‰ã€‚

> å¦‚æœæˆ‘ä»¬ä»¥æ¦‚ç‡ä¸ºåŸºç¡€æ¥è®²ï¼Œé‚£ä¹ˆæƒé‡åˆ—è¡¨å¯èƒ½æ˜¯ä¸€ä¸ªæ€»å’Œä¸º`1`çš„æµ®ç‚¹æ•°æ•°ç»„ï¼ˆä¾‹å¦‚`[0.1, 0.5, 0.2, 0.2]`ï¼‰ã€‚

**åŠ æƒéšæœº**æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šæ ¹æ®æ¯ä¸ªé¡¹ç›®çš„æƒé‡éšæœºè¿”å›åˆ—è¡¨ä¸­çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä½¿å¾—æƒé‡è¾ƒå¤§çš„é¡¹ç›®æ›´å®¹æ˜“è¢«é€‰ä¸­ã€‚

å‡½æ•°çš„ç¤ºä¾‹æ¥å£ï¼š

```javascript
const items =   [ 'ğŸŒ', 'ğŸ', 'ğŸ¥•' ];
const weights = [  3,    7,    1  ];

function weightedRandom(items, weights) {
  // å®ç°ä»£ç åœ¨è¿™é‡Œ...
}

const nextSnackToEat = weightedRandom(items, weights); // å¯èƒ½æ˜¯ 'ğŸ'
```

## åŠ æƒéšæœºçš„åº”ç”¨

- åœ¨[é—ä¼ ç®—æ³•](https://en.wikipedia.org/wiki/Genetic_algorithm)ä¸­ï¼ŒåŠ æƒéšæœºç”¨äº"é€‰æ‹©"é˜¶æ®µï¼Œå½“æˆ‘ä»¬éœ€è¦æ ¹æ®ä¸ªä½“çš„é€‚åº”åº¦è¯„åˆ†é€‰æ‹©æœ€é€‚åº”/æœ€å¼ºå¤§çš„ä¸ªä½“è¿›è¡Œäº¤é…ï¼Œå¹¶äº§ç”Ÿä¸‹ä¸€ä»£æ›´å¼ºå¤§çš„ä¸ªä½“ã€‚ä½ å¯ä»¥åœ¨[500è¡Œä»£ç ä¸­æ„å»ºè‡ªåŠ¨åœè½¦æ±½è½¦](https://trekhleb.dev/blog/2021/self-parking-car-evolution/)æ–‡ç« ä¸­æ‰¾åˆ°ä¸€ä¸ª**ç¤ºä¾‹**ã€‚
- åœ¨[å¾ªç¯ç¥ç»ç½‘ç»œ(RNN)](https://en.wikipedia.org/wiki/Recurrent_neural_network)ä¸­ï¼Œå½“æ ¹æ®ä¸‹ä¸€ä¸ªå­—æ¯çš„æ¦‚ç‡æ¥å†³å®šä¸‹ä¸€ä¸ªè¦é€‰æ‹©çš„å­—æ¯ï¼ˆä»¥å½¢æˆå¥å­ï¼‰æ—¶ä½¿ç”¨åŠ æƒéšæœºã€‚ä½ å¯ä»¥åœ¨[ä½¿ç”¨å¾ªç¯ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰ç”Ÿæˆé£Ÿè°±](https://nbviewer.org/github/trekhleb/machine-learning-experiments/blob/master/experiments/recipe_generation_rnn/recipe_generation_rnn.ipynb)çš„Jupyterç¬”è®°æœ¬ä¸­æ‰¾åˆ°ä¸€ä¸ª**ç¤ºä¾‹**ã€‚
- åœ¨[Nginxè´Ÿè½½å‡è¡¡](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/)ä¸­ï¼Œä¸ºäº†å°†HTTPè¯·æ±‚æ›´é¢‘ç¹åœ°å‘é€åˆ°æƒé‡è¾ƒé«˜çš„æœåŠ¡å™¨ã€‚
- ç­‰ç­‰...

## ç®—æ³•

**ç›´æ¥çš„æ–¹æ³•**å¦‚ä¸‹ï¼š

1. æ ¹æ®æƒé‡é‡å¤åˆ—è¡¨ä¸­çš„æ¯ä¸ªé¡¹ç›®ã€‚
2. ä»åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªé¡¹ç›®ã€‚

ä¾‹å¦‚ï¼Œåœ¨æ°´æœå’Œè”¬èœçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆå¤§å°ä¸º`3 + 7 + 1 = 11`çš„ä»¥ä¸‹åˆ—è¡¨ï¼š

```javascript
const items =   [ 'ğŸŒ', 'ğŸ', 'ğŸ¥•' ];
const weights = [  3,    7,    1  ];

// æ ¹æ®æƒé‡é‡å¤é¡¹ç›®ã€‚
const weightedItems = [
  'ğŸŒ', 'ğŸŒ', 'ğŸŒ',
  'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ',
  'ğŸ¥•',
];

// ç°åœ¨åªéœ€ä»weightedItemsæ•°ç»„ä¸­éšæœºé€‰æ‹©é¡¹ç›®ã€‚
```

ç„¶è€Œï¼Œæ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½éœ€è¦å¤§é‡çš„å†…å­˜ï¼Œç‰¹åˆ«æ˜¯å½“æˆ‘ä»¬éœ€è¦åœ¨`weightedItems`åˆ—è¡¨ä¸­é‡å¤å¾ˆå¤šé¡¹ç›®æ—¶ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ éœ€è¦å°†ä¸€ä¸ªå­—ç¬¦ä¸²å¦‚`"some-random-string"`ï¼ˆ`18`ä¸ªå­—èŠ‚ï¼‰é‡å¤åäº¿æ¬¡ã€‚ä½ å°†éœ€è¦é¢å¤–åˆ†é…å¤§çº¦`180Mb`çš„å†…å­˜ç©ºé—´æ¥å­˜å‚¨è¿™ä¸ªæ•°ç»„ã€‚

**æ›´é«˜æ•ˆçš„æ–¹æ³•**å¦‚ä¸‹ï¼š

1. å‡†å¤‡æ¯ä¸ªé¡¹ç›®çš„ç´¯ç§¯æƒé‡åˆ—è¡¨ï¼ˆå³`cumulativeWeights`åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å°†ä¸åŸå§‹çš„`weights`åˆ—è¡¨å…·æœ‰ç›¸åŒæ•°é‡çš„å…ƒç´ ï¼‰ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒå°†å¦‚ä¸‹æ‰€ç¤ºï¼š`cumulativeWeights = [3, 3 + 7, 3 + 7 + 1] = [3, 10, 11]`ã€‚
2. ç”Ÿæˆä»`0`åˆ°æœ€å¤§ç´¯ç§¯æƒé‡å€¼çš„éšæœºæ•°`randomNumber`ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œéšæœºæ•°å°†åœ¨`[0..11]`çš„èŒƒå›´å†…ã€‚å‡è®¾æˆ‘ä»¬æœ‰`randomNumber = 8`ã€‚
3. ä»å·¦åˆ°å³éå†`cumulativeWeights`åˆ—è¡¨ï¼Œå¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªå¤§äºæˆ–ç­‰äº`randomNumber`çš„å…ƒç´ ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªå…ƒç´ çš„ç´¢å¼•ä»`items`æ•°ç»„ä¸­é€‰æ‹©é¡¹ç›®ã€‚

è¿™ç§æ–¹æ³•çš„æ€æƒ³æ˜¯ï¼Œè¾ƒé«˜çš„æƒé‡å°†å æ®æ›´å¤šçš„æ•°å€¼ç©ºé—´ã€‚å› æ­¤ï¼Œéšæœºæ•°è½å…¥"è¾ƒé«˜æƒé‡æ•°å­—æ¡¶"çš„å¯èƒ½æ€§æ›´é«˜ã€‚

```javascript
const weights =           [3, 7,  1 ];
const cumulativeWeights = [3, 10, 11];

// ä»¥ä¼ªä»£ç çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è€ƒè™‘cumulativeWeightsæ•°ç»„ã€‚
const pseudoCumulativeWeights = [
  1, 2, 3,               // <-- [3]ä¸ªæ•°å­—
  4, 5, 6, 7, 8, 9, 10,  // <-- [7]ä¸ªæ•°å­—
  11,                    // <-- [1]ä¸ªæ•°å­—
];
```


ä¾‹ï¼š

```javascript
/**
 * æ ¹æ®æƒé‡é€‰æ‹©éšæœºé¡¹ç›®ã€‚
 * æƒé‡è¾ƒå¤§çš„é¡¹ç›®å°†è¢«æ›´é¢‘ç¹åœ°é€‰æ‹©ï¼ˆå…·æœ‰è¾ƒé«˜çš„æ¦‚ç‡ï¼‰ã€‚
 *
 * ä¾‹å¦‚ï¼š
 * - items = ['banana', 'orange', 'apple']
 * - weights = [0, 0.2, 0.8]
 * - weightedRandom(items, weights) åœ¨80%çš„æƒ…å†µä¸‹è¿”å›'apple'ï¼Œ
 *   åœ¨20%çš„æƒ…å†µä¸‹è¿”å›'orange'ï¼Œå®ƒæ°¸è¿œä¸ä¼šè¿”å›'banana'ï¼ˆå› ä¸ºé€‰æ‹©é¦™è•‰çš„æ¦‚ç‡ä¸º0%ï¼‰
 *
 * @param {any[]} items
 * @param {number[]} weights
 * @returns {{item: any, index: number}}
 */
export default function weightedRandom(items, weights) {
  if (items.length !== weights.length) {
    throw new Error('Items and weights must be of the same size');
  }

  if (!items.length) {
    throw new Error('Items must not be empty');
  }

  // å‡†å¤‡ç´¯ç§¯æƒé‡æ•°ç»„ã€‚
  // ä¾‹å¦‚ï¼š
  // - weights = [1, 4, 3]
  // - cumulativeWeights = [1, 5, 8]
  const cumulativeWeights = [];
  for (let i = 0; i < weights.length; i += 1) {
    cumulativeWeights[i] = weights[i] + (cumulativeWeights[i - 1] || 0);
  }

  // åœ¨èŒƒå›´[0...sum(weights)]å†…è·å–éšæœºæ•°
  // ä¾‹å¦‚ï¼š
  // - weights = [1, 4, 3]
  // - maxCumulativeWeight = 8
  // - éšæœºæ•°çš„èŒƒå›´æ˜¯[0...8]
  const maxCumulativeWeight = cumulativeWeights[cumulativeWeights.length - 1];
  const randomNumber = maxCumulativeWeight * Math.random();

  // æ ¹æ®æƒé‡é€‰æ‹©éšæœºé¡¹ç›®ã€‚
  // æƒé‡è¾ƒå¤§çš„é¡¹ç›®å°†è¢«æ›´é¢‘ç¹åœ°é€‰æ‹©ã€‚
  for (let itemIndex = 0; itemIndex < items.length; itemIndex += 1) {
    if (cumulativeWeights[itemIndex] >= randomNumber) {
      return {
        item: items[itemIndex],
        index: itemIndex,
      };
    }
  }
}
```

## å®ç°

- å¯ä»¥åœ¨[weightedRandom.js](weightedRandom.js)æ–‡ä»¶ä¸­æ‰¾åˆ°`weightedRandom()`å‡½æ•°çš„å®ç°ã€‚
- å¯ä»¥åœ¨[__test__/weightedRandom.test.js](__test__/weightedRandom.test.js)æ–‡ä»¶ä¸­æ‰¾åˆ°æµ‹è¯•ç”¨ä¾‹ã€‚
