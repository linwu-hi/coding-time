import{_ as p,r as o,o as c,c as i,a as n,b as s,e,d as t}from"./app-d7df62a4.js";const l={},r=n("h1",{id:"изменение-размеров-изображения-с-учетом-его-содержимого-в-javascript",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#изменение-размеров-изображения-с-учетом-его-содержимого-в-javascript","aria-hidden":"true"},"#"),s(" Изменение размеров изображения с учетом его содержимого в JavaScript")],-1),u=n("figure",null,[n("img",{src:"https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/01-cover-02.png",alt:"Content-aware image resizing in JavaScript",tabindex:"0",loading:"lazy"}),n("figcaption",null,"Content-aware image resizing in JavaScript")],-1),k={href:"https://trekhleb.dev/blog/2021/content-aware-image-resizing-in-javascript/",target:"_blank",rel:"noopener noreferrer"},d=t('<h2 id="tl-dr" tabindex="-1"><a class="header-anchor" href="#tl-dr" aria-hidden="true">#</a> TL;DR</h2><p>Написано много замечательных статей об алгоритме <em>Seam Carving</em> (&quot;Вырезание швов&quot;), но я не смог устоять перед соблазном самостоятельно исследовать этот элегантный, мощный и в то же время простой алгоритм и написать о своем личном опыте работы с ним. Мое внимание также привлек тот факт, что для его имплементации мы можем применить <em>динамическое программирование (DP)</em>. И, если вы, как и я, все еще находитесь на пути изучения алгоритмов, то это решение может обогатить ваш личный арсенал DP.</p><p>Итак, в этой статье я хочу сделать три вещи:</p><ol><li>Предоставить вам возможность &quot;поиграться&quot; с алгоритмом самостоятельно при помощи <strong>интерактивного ресайзера</strong>.</li><li>Объяснить <strong>идею алгоритма Seam Carving</strong>.</li><li>Объяснить как можно <strong>применить динамическое программирование</strong> для имплементации алгоритма (мы будем писать на TypeScript).</li></ol><h3 id="изменение-размеров-изображении-с-учетом-их-содержимого" tabindex="-1"><a class="header-anchor" href="#изменение-размеров-изображении-с-учетом-их-содержимого" aria-hidden="true">#</a> Изменение размеров изображений с учетом их содержимого</h3>',5),m=n("em",null,"Изменение размера изображения с учетом содержимого",-1),g={href:"https://perso.crans.org/frenoy/matlab2012/seamcarving.pdf",target:"_blank",rel:"noopener noreferrer"},v=n("em",null,"Shai Avidan",-1),h=n("em",null,"Ariel Shamir",-1),b=t('<p>В приведенном ниже примере показано, как ширина исходного изображения была уменьшена на 50% <em>с учетом содержимого изображения</em> (слева) и <em>без учета содержимого изображения</em> (справа, простой скейлинг). В данном случае левое изображение выглядит более естественным, так как пропорции воздушных шаров в нем были сохранены.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/01-resizing-options.png" alt="Content-aware image resizing" tabindex="0" loading="lazy"><figcaption>Content-aware image resizing</figcaption></figure><p>Идея алгоритма Seam Carving заключается в том, чтобы найти <em>шов</em> (seam, непрерывную последовательность пикселей) с наименьшим влиянием на содержание изображения, а затем его <em>вырезать</em> (carve). Этот процесс повторяется снова и снова, пока мы не получим требуемую ширину или высоту изображения. В примере ниже интуитивно видно, что пиксели воздушных шаров вносят больший &quot;вклад&quot; в содержание и смысл изображения, чем пиксели неба. Таким образом, сначала удаляются пиксели неба.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/10-demo-01.gif" alt="JS IMAGE CARVER DEMO" tabindex="0" loading="lazy"><figcaption>JS IMAGE CARVER DEMO</figcaption></figure><p>Поиск шва с наименьшей энергией (с наименьшим вкладом в содержимое изображения) является вычислительно дорогостоящей операцией (особенно для больших изображений). Для ускорения поиска шва может быть применено <em>динамическое программирование</em> (мы рассмотрим детали реализации ниже).</p><h3 id="удаление-объектов" tabindex="-1"><a class="header-anchor" href="#удаление-объектов" aria-hidden="true">#</a> Удаление объектов</h3><p>Важность каждого пикселя (так называемая энергия пикселя) вычисляется исходя из его цветовой разницы (<code>R</code>, <code>G</code>, <code>B</code>, <code>A</code>) между двумя соседними пикселями. Если же мы вручную зададим некоторым пикселям низкий уровень энергии (например нарисовав маску поверх них), то алгоритм Seam Carving выполнит для нас <strong>удаление помеченного объекта</strong>, как говорится, &quot;забесплатно&quot;.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/10-demo-02.gif" alt="JS IMAGE CARVER OBJECT REMOVAL DEMO" tabindex="0" loading="lazy"><figcaption>JS IMAGE CARVER OBJECT REMOVAL DEMO</figcaption></figure><h3 id="интерактивныи-ресзаизер" tabindex="-1"><a class="header-anchor" href="#интерактивныи-ресзаизер" aria-hidden="true">#</a> Интерактивный ресзайзер</h3>',9),y={href:"https://trekhleb.dev/js-image-carver/",target:"_blank",rel:"noopener noreferrer"},f={href:"https://github.com/trekhleb/js-image-carver",target:"_blank",rel:"noopener noreferrer"},w=t('<h3 id="другие-примеры-ресаиза" tabindex="-1"><a class="header-anchor" href="#другие-примеры-ресаиза" aria-hidden="true">#</a> Другие примеры ресайза</h3><p>Вот еще несколько примеров того, как алгоритм справляется с более сложным фоном.</p><p>Горы на заднем плане плавно сжимаются, без видимых швов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/11-demo-01.png" alt="Resizing demo with more complex backgrounds" tabindex="0" loading="lazy"><figcaption>Resizing demo with more complex backgrounds</figcaption></figure><p>То же самое и с океанскими волнами. Алгоритм сохранил волновую структуру, не искажая серферов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/11-demo-02.png" alt="Resizing demo with more complex backgrounds" tabindex="0" loading="lazy"><figcaption>Resizing demo with more complex backgrounds</figcaption></figure><p>Нужно помнить, что алгоритм Seam Carving не является &quot;волшебной таблеткой&quot;, и может не сохранить пропорции важных частей изображения в том случае, когда <em>большая часть пикселей выглядят как края, ребра или границы</em> (почти все пиксели выглядят одинаково важными с точки зрения алгоритма). В приведенном ниже примере изменение размера изображения с учетом содержимого похоже на простое масштабирование, т.к. для алгоритма все пиксели выглядят важными, и ему трудно отличить лицо Ван Гога от фона.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/12-demo-01.png" alt="Example when the algorithm does not work as expected" tabindex="0" loading="lazy"><figcaption>Example when the algorithm does not work as expected</figcaption></figure><h2 id="как-работает-алгоритм-seam-carving" tabindex="-1"><a class="header-anchor" href="#как-работает-алгоритм-seam-carving" aria-hidden="true">#</a> Как работает алгоритм Seam Carving</h2><p>Представим, что у нас есть картинка размером <code>1000 x 500 px</code>, и мы хотим уменьшить ее до <code>500 x 500 px</code> (допустим, квадратное изображение больше подходит для Instagram). В этом случае мы, возможно, захотим задать несколько <strong>требований к процессу изменения размера</strong>:</p><ul><li><em>Важные части изображения должны быть сохранены</em> (если до ресайза на фото было 5 деревьев, то и после ресайза мы хотим увидеть все те же 5 деревьев).</li><li><em>Пропорции важных частей изображения должны быть сохранены</em> (круглые колеса автомобиля не должны стать овальными после ресайза).</li></ul><p>Чтобы избежать изменения важных частей изображения можно найти <strong>непрерывную последовательность пикселей (шов)</strong>, которая будет идти от верхней границы к нижней и иметь <em>наименьший вклад в содержимое</em> изображения (шов, который не проходит через важные части изображения), а затем удалить его. Удаление шва сожмет изображение на один пиксель. Далее надо повторять этот шаг до тех пор, пока изображение не станет нужной ширины.</p><p>Вопрос в том, как определить <em>важность пикселя</em> и его вклад в содержание изображения (в оригинальной статье авторы используют термин <strong>энергия пикселя</strong>). Один из способов это сделать — рассматривать все пиксели, образующие края (границы, ребра), как важные. В случае, если пиксель является частью ребра, его цвет будет отличаться от соседей (левого и правого пикселей).</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/30-pixel-energy-comparison.png" alt="Pixels color difference" tabindex="0" loading="lazy"><figcaption>Pixels color difference</figcaption></figure><p>Предполагая, что цвет пикселя представлен <em>4-мя</em> числами (<code>R</code> - красный, <code>G</code> - зеленый, <code>B</code> - синий, <code>A</code> - альфа, прозрачность), мы можем использовать следующую формулу для вычисления разницы в цвете (энергии пикселя):</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/20-energy-formula.png" alt="Pixel energy formula" tabindex="0" loading="lazy"><figcaption>Pixel energy formula</figcaption></figure><p>Где:</p><ul><li><code>mEnergy</code> - <em>Энергия</em> (важность) <em>среднего</em> пикселя (<code>[0..626]</code> если округлить)</li><li><code>lR</code> - <em>Красный</em> цветовой канал <em>левого</em> пикселя (<code>[0..255]</code>)</li><li><code>mR</code> - <em>Красный</em> цветовой канал <em>среднего</em> пикселя (<code>[0..255]</code>)</li><li><code>rR</code> - <em>Красный</em> цветовой канал <em>правого</em> пикселя (<code>[0..255]</code>)</li><li><code>lG</code> - <em>Зеленый</em> цветовой канал <em>левого</em> пикселя (<code>[0..255]</code>)</li><li>и так далее...</li></ul><p>В приведенной выше формуле мы пока не используем альфа-канал (прозрачность), предполагая, что изображение не содержит прозрачные пиксели. Позже мы будем использовать альфа-канал для маскировки и удаления объектов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/30-pixel-energy-calculation-example.png" alt="Example of pixel energy calculation" tabindex="0" loading="lazy"><figcaption>Example of pixel energy calculation</figcaption></figure><p>Поскольку мы знаем, как найти энергию одного пикселя, мы можем вычислить так называемую <strong>энергетическую карту</strong>, которая будет содержать энергии каждого пикселя изображения. На каждом шаге изменения размера изображения карту энергий необходимо пересчитывать (по крайней мере частично, подробнее об этом ниже), и она будет иметь тот же размер, что и изображение.</p><p>Например, на 1-м шаге у нас будет изображение размером <code>1000 x 500</code> и энергетическая карта размером <code>1000 x 500</code>. На 2-м шаге изменения размера мы удалим шов с изображения и пересчитаем карту энергий на основе нового уменьшенного изображения. Таким образом, мы получим изображение размером <code>999 x 500</code> и карту энергий размером <code>999 x 500</code>.</p><p>Чем выше энергия пикселя, тем больше вероятность того, что он является частью ребра, важен для содержимого изображения и тем меньше вероятность того, что нам потребуется его удалить.</p><p>Для визуализации карты энергий мы можем присвоить более яркий цвет пикселям с большей энергией и более темные цвета пикселям с меньшей энергией. Вот как может выглядеть часть карты энергий. Вы можете увидеть светлую линию, которая представляет край и которую мы хотим сохранить при изменении размера.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/30-energy-map-padding.png" alt="Energy map sketch" tabindex="0" loading="lazy"><figcaption>Energy map sketch</figcaption></figure><p>Вот реальный пример энергетической карты для изображения, которое вы видели выше (с воздушными шарами).</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/40-energy-map.png" alt="Energy map example" tabindex="0" loading="lazy"><figcaption>Energy map example</figcaption></figure>',27),x={href:"https://trekhleb.dev/blog/2021/content-aware-image-resizing-in-javascript/",target:"_blank",rel:"noopener noreferrer"},_=t('<p>Мы можем использовать энергетическую карту, чтобы найти швы (один за другим) с наименьшей энергией и тем самым решить, какие пиксели в конечном итоге должны быть удалены.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/41-seam-search.png" alt="Searching the seam" tabindex="0" loading="lazy"><figcaption>Searching the seam</figcaption></figure><p>Поиск шва с наименьшими затратами энергии не является тривиальной задачей и требует перебора множества возможных комбинаций пикселей. Мы применим динамическое программирование для оптимизации поиска шва.</p><p>В примере ниже вы можете увидеть карту энергий с первым найденным для нее швом с наименьшей энергией.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/40-energy-map-with-seam.png" alt="Energy map example with seam" tabindex="0" loading="lazy"><figcaption>Energy map example with seam</figcaption></figure><p>В приведенных выше примерах мы уменьшали ширину изображения. Аналогичный подход может быть использован для уменьшения высоты изображения. Для этого нам нужно:</p><ul><li>начать использовать соседей <em>сверху</em> и <em>снизу</em>, а не <em>слева</em> и <em>справа</em>, для вычисления энергии пикселя</li><li>при поиске шва нам нужно двигаться <em>слева</em> <em>направо</em>, а не <em>сверху</em> <em>вниз</em>.</li></ul><h2 id="реализация-алгоритма-на-typescript" tabindex="-1"><a class="header-anchor" href="#реализация-алгоритма-на-typescript" aria-hidden="true">#</a> Реализация алгоритма на TypeScript</h2>',8),E={href:"https://github.com/trekhleb/js-image-carver",target:"_blank",rel:"noopener noreferrer"},z=t(`<p>Для реализации алгоритма мы будем использовать TypeScript. Если вам нужна версия на JavaScript, вы можете игнорировать (удалить) определения типов и их использование.</p><p>Для простоты примеров мы напишем код только для уменьшения <em>ширины</em> изображения.</p><h3 id="уменьшение-ширины-с-учетом-содержимого-изображения-исходная-функция" tabindex="-1"><a class="header-anchor" href="#уменьшение-ширины-с-учетом-содержимого-изображения-исходная-функция" aria-hidden="true">#</a> Уменьшение ширины с учетом содержимого изображения (исходная функция)</h3><p>Для начала определим некоторые общие типы, которые мы будем использовать при реализации алгоритма.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Type that describes the image size (width and height).</span>
<span class="token keyword">type</span> <span class="token class-name">ImageSize</span> <span class="token operator">=</span> <span class="token punctuation">{</span> w<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> h<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The coordinate of the pixel.</span>
<span class="token keyword">type</span> <span class="token class-name">Coordinate</span> <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The seam is a sequence of pixels (coordinates).</span>
<span class="token keyword">type</span> <span class="token class-name">Seam</span> <span class="token operator">=</span> Coordinate<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Energy map is a 2D array that has the same width and height</span>
<span class="token comment">// as the image the map is being calculated for.</span>
<span class="token keyword">type</span> <span class="token class-name">EnergyMap</span> <span class="token operator">=</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Type that describes the image pixel&#39;s RGBA color.</span>
<span class="token keyword">type</span> <span class="token class-name">Color</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  r<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Red</span>
  g<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Green</span>
  b<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Blue</span>
  a<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Alpha (transparency)</span>
<span class="token punctuation">]</span> <span class="token operator">|</span> Uint8ClampedArray<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Для имплементации алгоритма нам необходимо выполнить следующие шаги:</p><ol><li>Рассчитать <strong>карту энергии</strong> для текущей версии изображения.</li><li>Найти <strong>шов</strong> с наименьшей энергией на основе карты энергий (здесь мы применим динамическое программирование).</li><li><strong>Удалить шов</strong> с наименьшей энергией из изображения.</li><li><strong>Повторять</strong> до тех пор, пока ширина изображения не будет уменьшена до нужного значения.</li></ol><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">ResizeImageWidthArgs</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token comment">// Image data we want to resize.</span>
  toWidth<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Final image width we want the image to shrink to.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">ResizeImageWidthResult</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token comment">// Resized image data.</span>
  size<span class="token operator">:</span> ImageSize<span class="token punctuation">,</span> <span class="token comment">// Resized image size (w x h).</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Performs the content-aware image width resizing using the seam carving method.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> resizeImageWidth <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token punctuation">{</span> img<span class="token punctuation">,</span> toWidth <span class="token punctuation">}</span><span class="token operator">:</span> ResizeImageWidthArgs<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ResizeImageWidthResult <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// For performance reasons we want to avoid changing the img data array size.</span>
  <span class="token comment">// Instead we&#39;ll just keep the record of the resized image width and height separately.</span>
  <span class="token keyword">const</span> size<span class="token operator">:</span> ImageSize <span class="token operator">=</span> <span class="token punctuation">{</span> w<span class="token operator">:</span> img<span class="token punctuation">.</span>width<span class="token punctuation">,</span> h<span class="token operator">:</span> img<span class="token punctuation">.</span>height <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Calculating the number of pixels to remove.</span>
  <span class="token keyword">const</span> pxToRemove <span class="token operator">=</span> img<span class="token punctuation">.</span>width <span class="token operator">-</span> toWidth<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pxToRemove <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Upsizing is not supported for now&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> energyMap<span class="token operator">:</span> EnergyMap <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> seam<span class="token operator">:</span> Seam <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// Removing the lowest energy seams one by one.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pxToRemove<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Calculate the energy map for the current version of the image.</span>
    energyMap <span class="token operator">=</span> <span class="token function">calculateEnergyMap</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. Find the seam with the lowest energy based on the energy map.</span>
    seam <span class="token operator">=</span> <span class="token function">findLowEnergySeam</span><span class="token punctuation">(</span>energyMap<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. Delete the seam with the lowest energy seam from the image.</span>
    <span class="token function">deleteSeam</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> seam<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Reduce the image width, and continue iterations.</span>
    size<span class="token punctuation">.</span>w <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Returning the resized image and its final size.</span>
  <span class="token comment">// The img is actually a reference to the ImageData, so technically</span>
  <span class="token comment">// the caller of the function already has this pointer. But let&#39;s</span>
  <span class="token comment">// still return it for better code readability.</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> img<span class="token punctuation">,</span> size <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,8),S={href:"https://developer.mozilla.org/en-US/docs/Web/API/ImageData",target:"_blank",rel:"noopener noreferrer"},R=t(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imgData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,1),C={href:"https://github.com/trekhleb/js-image-carver",target:"_blank",rel:"noopener noreferrer"},M=t(`<p>Теперь, пошагово реализуем функции <code>calculateEnergyMap()</code>, <code>findLowEnergySeam()</code> и <code>deleteSeam()</code>.</p><h3 id="расчет-энергии-пикселя" tabindex="-1"><a class="header-anchor" href="#расчет-энергии-пикселя" aria-hidden="true">#</a> Расчет энергии пикселя</h3><p>Для расчета воспользуемся формулой разницы цветов, описанной выше. Для левой и правой краев изображения (когда нет левого или правого соседей) мы игнорируем соседей и не учитываем их при расчете энергии.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Calculates the energy of a pixel.</span>
<span class="token keyword">const</span> getPixelEnergy <span class="token operator">=</span> <span class="token punctuation">(</span>left<span class="token operator">:</span> Color <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> middle<span class="token operator">:</span> Color<span class="token punctuation">,</span> right<span class="token operator">:</span> Color <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Middle pixel is the pixel we&#39;re calculating the energy for.</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>mR<span class="token punctuation">,</span> mG<span class="token punctuation">,</span> mB<span class="token punctuation">]</span> <span class="token operator">=</span> middle<span class="token punctuation">;</span>

  <span class="token comment">// Energy from the left pixel (if it exists).</span>
  <span class="token keyword">let</span> lEnergy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>lR<span class="token punctuation">,</span> lG<span class="token punctuation">,</span> lB<span class="token punctuation">]</span> <span class="token operator">=</span> left<span class="token punctuation">;</span>
    lEnergy <span class="token operator">=</span> <span class="token punctuation">(</span>lR <span class="token operator">-</span> mR<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>lG <span class="token operator">-</span> mG<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>lB <span class="token operator">-</span> mB<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Energy from the right pixel (if it exists).</span>
  <span class="token keyword">let</span> rEnergy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>rR<span class="token punctuation">,</span> rG<span class="token punctuation">,</span> rB<span class="token punctuation">]</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
    rEnergy <span class="token operator">=</span> <span class="token punctuation">(</span>rR <span class="token operator">-</span> mR<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rG <span class="token operator">-</span> mG<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rB <span class="token operator">-</span> mB<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Resulting pixel energy.</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>lEnergy <span class="token operator">+</span> rEnergy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="расчет-энергетическои-карты" tabindex="-1"><a class="header-anchor" href="#расчет-энергетическои-карты" aria-hidden="true">#</a> Расчет энергетической карты</h3>`,5),I={href:"https://developer.mozilla.org/en-US/docs/Web/API/ImageData",target:"_blank",rel:"noopener noreferrer"},j={href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8ClampedArray",target:"_blank",rel:"noopener noreferrer"},P=n("em",null,"2D",-1),A=t(`<div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Helper function that returns the color of the pixel.</span>
<span class="token keyword">const</span> getPixel <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token operator">:</span> Coordinate<span class="token punctuation">)</span><span class="token operator">:</span> Color <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The ImageData data array is a flat 1D array.</span>
  <span class="token comment">// Thus we need to convert x and y coordinates to the linear index.</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> y <span class="token operator">*</span> img<span class="token punctuation">.</span>width <span class="token operator">+</span> x<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cellsPerColor <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// RGBA</span>
  <span class="token comment">// For better efficiency, instead of creating a new sub-array we return</span>
  <span class="token comment">// a pointer to the part of the ImageData array.</span>
  <span class="token keyword">return</span> img<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span>i <span class="token operator">*</span> cellsPerColor<span class="token punctuation">,</span> i <span class="token operator">*</span> cellsPerColor <span class="token operator">+</span> cellsPerColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Helper function that sets the color of the pixel.</span>
<span class="token keyword">const</span> setPixel <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token operator">:</span> Coordinate<span class="token punctuation">,</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The ImageData data array is a flat 1D array.</span>
  <span class="token comment">// Thus we need to convert x and y coordinates to the linear index.</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> y <span class="token operator">*</span> img<span class="token punctuation">.</span>width <span class="token operator">+</span> x<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cellsPerColor <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// RGBA</span>
  img<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> i <span class="token operator">*</span> cellsPerColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Для вычисления карты энергии мы проходим через каждый пиксель изображения и вызываем для него описанную ранее функцию <code>getPixelEnergy()</code>.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Helper function that creates a matrix (2D array) of specific</span>
<span class="token comment">// size (w x h) and fills it with specified value.</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>w<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> h<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> filler<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>filler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Calculates the energy of each pixel of the image.</span>
<span class="token keyword">const</span> calculateEnergyMap <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token punctuation">{</span> w<span class="token punctuation">,</span> h <span class="token punctuation">}</span><span class="token operator">:</span> ImageSize<span class="token punctuation">)</span><span class="token operator">:</span> EnergyMap <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create an empty energy map where each pixel has infinitely high energy.</span>
  <span class="token comment">// We will update the energy of each pixel.</span>
  <span class="token keyword">const</span> energyMap<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">matrix</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> h<span class="token punctuation">;</span> y <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Left pixel might not exist if we&#39;re on the very left edge of the image.</span>
      <span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// The color of the middle pixel that we&#39;re calculating the energy for.</span>
      <span class="token keyword">const</span> middle <span class="token operator">=</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Right pixel might not exist if we&#39;re on the very right edge of the image.</span>
      <span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> w <span class="token operator">?</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      energyMap<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getPixelEnergy</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> middle<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> energyMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),D={href:"https://github.com/trekhleb/js-image-carver",target:"_blank",rel:"noopener noreferrer"},T=n("h3",{id:"нахождение-шва-с-минимальнои-энергиеи-применяем-динамическое-программирование",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#нахождение-шва-с-минимальнои-энергиеи-применяем-динамическое-программирование","aria-hidden":"true"},"#"),s(" Нахождение шва с минимальной энергией (применяем динамическое программирование)")],-1),q={href:"https://trekhleb.dev/blog/2018/dynamic-programming-vs-divide-and-conquer/",target:"_blank",rel:"noopener noreferrer"},G=t('<p>Проблема, которую нам необходимо решить заключается в нахождении пути (шва) на энергетической карте, который идет от верхней границы изображения к нижней и имеет минимальную энергию (сумма энергий пикселей, составляющих шов должна быть минимальной).</p><h4 id="наивныи-подход-naive" tabindex="-1"><a class="header-anchor" href="#наивныи-подход-naive" aria-hidden="true">#</a> &quot;Наивный&quot; подход (naive)</h4><p>Прямолинейный (&quot;наивный&quot;) подход — перебрать все возможные пути один за другим.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/50-naive-approach.png" alt="The naive approach" tabindex="0" loading="lazy"><figcaption>The naive approach</figcaption></figure><p>Двигаясь сверху вниз, для каждого пикселя у нас есть 3 варианта (↙︎ идти вниз-влево, ↓ вниз, ↘︎ идти вниз-вправо). Это дает нам временную сложность <code>O (w * 3 ^ h)</code> или просто <code>O (3 ^ h)</code>, где <code>w</code> и<code> h</code> - ширина и высота изображения. Такой подход выглядит неоптимальным.</p><h4 id="жадныи-подход-greedy" tabindex="-1"><a class="header-anchor" href="#жадныи-подход-greedy" aria-hidden="true">#</a> &quot;Жадный&quot; подход (greedy)</h4><p>Жадный подход — выбирать следующий пиксель как пиксель с наименьшей энергией, надеясь, что результирующая энергия шва будет наименьшей.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/51-greedy-approach.png" alt="The greedy approach" tabindex="0" loading="lazy"><figcaption>The greedy approach</figcaption></figure><p>Жадный подход приведет нас к не самому худшему решению, но он не сможет гарантировать, что мы найдем наилучшее доступное решение. На картинке выше видно, как мы выбрали <code>5</code> вместо <code>10</code> и пропустили цепочку оптимальных пикселей.</p><p>Плюс этого подхода в том, что он быстрый и имеет временную сложность <code>O(w + h)</code>, где <code>w</code> и <code>h</code> - это ширина и высота изображения. В этом случае плата за скорость — низкое качество ресайза (много искажений). Временная сложность обусловлена тем, что нужно найти минимальное значение в первом ряду (обход <code>w</code> ячеек), а затем исследовать только 3 соседних пикселя для каждого ряда (обход <code>h</code> рядов).</p><h4 id="используем-динамическое-программирование" tabindex="-1"><a class="header-anchor" href="#используем-динамическое-программирование" aria-hidden="true">#</a> Используем динамическое программирование</h4><p>Вы, наверное, заметили, что в наивном подходе мы снова и снова суммировали одни и те же энергии пикселей, вычисляя энергию образовавшихся швов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/52-dp-repeated-problems.png" alt="Repeated problems" tabindex="0" loading="lazy"><figcaption>Repeated problems</figcaption></figure><p>В примере выше видно, что для первых двух швов мы повторно используем энергию более короткого шва (который имеет энергию <code>235</code>). Вместо одной операции <code>235 + 70</code> для вычисления энергии 2-го шва мы делаем четыре операции <code>(5 + 0 + 80 + 150) + 70</code>.</p>',14),B={href:"https://trekhleb.dev/blog/2018/dynamic-programming-vs-divide-and-conquer/",target:"_blank",rel:"noopener noreferrer"},O=n("em",null,"может",-1),J=t(`<p>Таким образом, мы можем <strong>сохранить энергию текущего шва</strong> для конкретного пикселя в дополнительной таблице <code>samsEnergies</code>, чтобы повторно использовать ее при расчете энергии следующих швов (таблица <code>samsEnergies</code> будет иметь тот же размер, что и энергетическая карта и само изображение).</p><p>Обратите также внимание, что для большинства пикселей в изображении (например, для левого нижнего) мы можем иметь <em>несколько</em> значений энергий предыдущих швов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/53-dp-what-to-choose.png" alt="What seam to choose" tabindex="0" loading="lazy"><figcaption>What seam to choose</figcaption></figure><p>Так как мы ищем шов с наименьшей результирующей энергией, имеет смысл выбирать и предыдущий шов с наименьшей результирующей энергией.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/56-dp-seams-energies-example.png" alt="Seams energies example" tabindex="0" loading="lazy"><figcaption>Seams energies example</figcaption></figure><p>Как правило, у нас есть три возможных предыдущих шва, которые текущий пиксель продолжает:</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/55-dp-three-options.png" alt="Three options to choose from" tabindex="0" loading="lazy"><figcaption>Three options to choose from</figcaption></figure><p>Можем посмотреть на это с такой стороны:</p><ul><li>Ячейка <code>[1][x]</code>: содержит наименьшую возможную энергию шва, который начинается где-то в ряду <code>[0][?] </code> и заканчивается в ячейке <code>[1][x]</code>.</li><li><strong>Текущая ячейка</strong> <code>[2][3]</code>: содержит наименьшую возможную энергию шва, который начинается где-то в ряду <code>[0][?] </code> и заканчивается в ячейке <code>[2][3]</code>. Для вычисления нужно суммировать энергию текущего пикселя <code>[2][3]</code> (из энергетической карты) с <code>min(seam_energy_1_2, seam_energy_1_3, seam_energy_1_4)</code>.</li></ul><p>Если мы заполним таблицу <code>ShesamsEnergies</code> полностью, то минимальное число в нижнем ряду будет наименьшей возможной энергией шва.</p><p>Попробуем заполнить несколько ячеек этой таблицы, чтобы посмотреть, как это работает.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/57-dp-seams-energies-traversal.png" alt="Seams energies map traversal" tabindex="0" loading="lazy"><figcaption>Seams energies map traversal</figcaption></figure><p>После заполнения таблицы <code>ShesamsEnergies</code> видно, что в нижнем ряду пиксель с самой низкой энергией имеет значение <code>50</code>. Для удобства во время генерации <code>samsEnergies</code> для каждого пикселя мы можем сохранить не только энергию шва, но и координаты предыдущего шва с наименьшей энергией. Это даст нам возможность легко восстанавливать траекторию шва снизу вверх.</p><p>Временная сложность DP подхода составит <code>O(w * h)</code>, где <code>w</code> и <code>h</code> - это ширина и высота изображения. Обусловлена она тем, что нужно вычислить энергии для <em>всех</em> пикселей изображения.</p><p>Вот пример того, как эта логика может быть реализована:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// The metadata for the pixels in the seam.</span>
<span class="token keyword">type</span> <span class="token class-name">SeamPixelMeta</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  energy<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// The energy of the pixel.</span>
  coordinate<span class="token operator">:</span> Coordinate<span class="token punctuation">,</span> <span class="token comment">// The coordinate of the pixel.</span>
  previous<span class="token operator">:</span> Coordinate <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// The previous pixel in a seam.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Finds the seam (the sequence of pixels from top to bottom) that has the</span>
<span class="token comment">// lowest resulting energy using the Dynamic Programming approach.</span>
<span class="token keyword">const</span> findLowEnergySeam <span class="token operator">=</span> <span class="token punctuation">(</span>energyMap<span class="token operator">:</span> EnergyMap<span class="token punctuation">,</span> <span class="token punctuation">{</span> w<span class="token punctuation">,</span> h <span class="token punctuation">}</span><span class="token operator">:</span> ImageSize<span class="token punctuation">)</span><span class="token operator">:</span> Seam <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The 2D array of the size of w and h, where each pixel contains the</span>
  <span class="token comment">// seam metadata (pixel energy, pixel coordinate and previous pixel from</span>
  <span class="token comment">// the lowest energy seam at this point).</span>
  <span class="token keyword">const</span> seamsEnergies<span class="token operator">:</span> <span class="token punctuation">(</span>SeamPixelMeta <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">matrix</span><span class="token generic class-name"><span class="token operator">&lt;</span>SeamPixelMeta <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Populate the first row of the map by just copying the energies</span>
  <span class="token comment">// from the energy map.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      energy<span class="token operator">:</span> energyMap<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>
      coordinate<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">,</span>
      previous<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Populate the rest of the rows.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> h<span class="token punctuation">;</span> y <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Find the top adjacent cell with minimum energy.</span>
      <span class="token comment">// This cell would be the tail of a seam with lowest energy at this point.</span>
      <span class="token comment">// It doesn&#39;t mean that this seam (path) has lowest energy globally.</span>
      <span class="token comment">// Instead, it means that we found a path with the lowest energy that may lead</span>
      <span class="token comment">// us to the current pixel with the coordinates x and y.</span>
      <span class="token keyword">let</span> minPrevEnergy <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> minPrevX<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> w <span class="token operator">&amp;&amp;</span> seamsEnergies<span class="token punctuation">[</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>energy <span class="token operator">&lt;</span> minPrevEnergy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          minPrevEnergy <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>energy<span class="token punctuation">;</span>
          minPrevX <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Update the current cell.</span>
      seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        energy<span class="token operator">:</span> minPrevEnergy <span class="token operator">+</span> energyMap<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>
        coordinate<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">,</span>
        previous<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> minPrevX<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Find where the minimum energy seam ends.</span>
  <span class="token comment">// We need to find the tail of the lowest energy seam to start</span>
  <span class="token comment">// traversing it from its tail to its head (from the bottom to the top).</span>
  <span class="token keyword">let</span> lastMinCoordinate<span class="token operator">:</span> Coordinate <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> minSeamEnergy <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>energy <span class="token operator">&lt;</span> minSeamEnergy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      minSeamEnergy <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>energy<span class="token punctuation">;</span>
      lastMinCoordinate <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Find the lowest energy energy seam.</span>
  <span class="token comment">// Once we know where the tail is we may traverse and assemble the lowest</span>
  <span class="token comment">// energy seam based on the &quot;previous&quot; value of the seam pixel metadata.</span>
  <span class="token keyword">const</span> seam<span class="token operator">:</span> Seam <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastMinCoordinate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> seam<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> lastMinX<span class="token punctuation">,</span> y<span class="token operator">:</span> lastMinY <span class="token punctuation">}</span> <span class="token operator">=</span> lastMinCoordinate<span class="token punctuation">;</span>

  <span class="token comment">// Adding new pixel to the seam path one by one until we reach the top.</span>
  <span class="token keyword">let</span> currentSeam <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>lastMinY<span class="token punctuation">]</span><span class="token punctuation">[</span>lastMinX<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentSeam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    seam<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentSeam<span class="token punctuation">.</span>coordinate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevMinCoordinates <span class="token operator">=</span> currentSeam<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevMinCoordinates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentSeam <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> prevMinX<span class="token punctuation">,</span> y<span class="token operator">:</span> prevMinY <span class="token punctuation">}</span> <span class="token operator">=</span> prevMinCoordinates<span class="token punctuation">;</span>
      currentSeam <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>prevMinY<span class="token punctuation">]</span><span class="token punctuation">[</span>prevMinX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> seam<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="удаление-шва-с-минимальнои-энергиеи" tabindex="-1"><a class="header-anchor" href="#удаление-шва-с-минимальнои-энергиеи" aria-hidden="true">#</a> Удаление шва с минимальной энергией</h3><p>Как только мы нашли шов с наименьшей суммарной энергией, нам нужно удалить (вырезать) пиксели, которые образуют его из изображения. Удаление происходит путем смещения пикселей справа от шва на <code>1px</code> влево. Из соображений производительности мы не будем удалять крайний столбик пикселей. Вместо этого, компонент, отвечающий за отрисовку уменьшенного изображения просто проигнорирует ту часть изображения, которая лежит за пределами обрезанной ширины.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/60-deleting-example.png" alt="Deleting the seam" tabindex="0" loading="lazy"><figcaption>Deleting the seam</figcaption></figure><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Deletes the seam from the image data.</span>
<span class="token comment">// We delete the pixel in each row and then shift the rest of the row pixels to the left.</span>
<span class="token keyword">const</span> deleteSeam <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> seam<span class="token operator">:</span> Seam<span class="token punctuation">,</span> <span class="token punctuation">{</span> w <span class="token punctuation">}</span><span class="token operator">:</span> ImageSize<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  seam<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> seamX<span class="token punctuation">,</span> y<span class="token operator">:</span> seamY <span class="token punctuation">}</span><span class="token operator">:</span> Coordinate<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> seamX<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span>w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> nextPixel <span class="token operator">=</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span> seamY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token operator">:</span> seamY <span class="token punctuation">}</span><span class="token punctuation">,</span> nextPixel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="удаление-объектов-с-изображения" tabindex="-1"><a class="header-anchor" href="#удаление-объектов-с-изображения" aria-hidden="true">#</a> Удаление объектов с изображения</h2><p>Seam Carving алгоритм пытается сначала удалить швы, состоящие из низкоэнергетических пикселей. Мы могли бы использовать этот факт и, присвоив низкую энергию некоторым пикселям вручную (например, нарисовав на изображении маску), мы могли бы заставить алгоритм удалить отмеченные пиксели (<em>объекты</em>).</p>`,22),W=n("code",null,"getPixelEnergy()",-1),V=n("code",null,"R",-1),L=n("code",null,"G",-1),U=n("code",null,"B",-1),X=n("code",null,"A",-1),F={href:"https://github.com/trekhleb/js-image-carver/blob/main/src/utils/contentAwareResizer.ts#L54",target:"_blank",rel:"noopener noreferrer"},Y=n("p",null,"Вот как при этом будет выглядеть удаление объектов:",-1),H=n("figure",null,[n("img",{src:"https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/10-demo-02.gif",alt:"JS IMAGE CARVER OBJECT REMOVAL DEMO",tabindex:"0",loading:"lazy"}),n("figcaption",null,"JS IMAGE CARVER OBJECT REMOVAL DEMO")],-1),N=n("h2",{id:"проблемы-алгоритма-и-дальнеишие-планы",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#проблемы-алгоритма-и-дальнеишие-планы","aria-hidden":"true"},"#"),s(" Проблемы алгоритма и дальнейшие планы")],-1),K={href:"https://github.com/trekhleb/js-image-carver",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://perso.crans.org/frenoy/matlab2012/seamcarving.pdf",target:"_blank",rel:"noopener noreferrer"},Z=n("strong",null,"увеличения изображения",-1),$=n("strong",null,"автоматического расширения изображения до его исходной ширины после удаления объектов",-1),nn=n("p",null,[s("Еще одной интересной областью экспериментов может быть попытка ускорить алгоритм, чтобы он работал в режиме "),n("strong",null,"реального времени"),s(".")],-1),sn=n("blockquote",null,[n("p",null,"Таковы планы на будущее, но пока, надеюсь, пример с уменьшением изображения был интересен и полезен для вас. Также надеюсь, что вам было интересно увидеть применение динамического программирования в задачах, приближенных к реальности."),n("p",null,"Удачи с вашими собственными экспериментами!")],-1);function an(en,tn){const a=o("ExternalLinkIcon");return c(),i("div",null,[r,u,n("blockquote",null,[n("p",null,[s("Доступна "),n("a",k,[s("английская интерактивная версия этой статьи"),e(a)]),s(' в которой вы можете загрузить свои собственные изображения и посмотреть, как алгоритм "справляется" с ними.')])]),d,n("p",null,[m,s(" (content-aware image resizing) может быть применено, когда дело доходит до изменения пропорций изображения (например, уменьшения ширины при сохранении высоты), а также когда потеря некоторых частей изображения нежелательна. Простое масштабирование изображения в этом случае исказит находящиеся в нем объекты. Для сохранения пропорций объектов при изменении пропорций изображения можно использовать "),n("a",g,[s("алгоритм Seam Carving"),e(a)]),s(", который был описан "),v,s(" и "),h,s(".")]),b,n("p",null,[s("Для этой статьи я создал приложение "),n("a",y,[s("JS IMAGE CARVER"),e(a)]),s(" (доступен также и "),n("a",f,[s("исходный код на GitHub"),e(a)]),s("), которым вы можете воспользоваться для ресайза своих изображений и увидеть в реальном времени, как работает алгоритм.")]),w,n("p",null,[s("Вы можете загрузить свое изображение и посмотреть, как будет выглядеть энергетическая карта в "),n("a",x,[s("интерактивной версии статьи"),e(a)]),s(".")]),_,n("blockquote",null,[n("p",null,[s("Исходный код и функции, упомянутые ниже, можно найти в репозитории "),n("a",E,[s("js-image-carver"),e(a)]),s(".")])]),z,n("p",null,[s("Изображение, которому необходимо изменить размер, передается в функцию в формате "),n("a",S,[s("ImageData"),e(a)]),s(". Вы можете отобразить изображение на canvas-е, а затем извлечь ImageData из того же canvas-а следующим образом:")]),R,n("blockquote",null,[n("p",null,[s("Загрузка и отрисовка изображений в JavaScript выходит за рамки данной статьи, но вы можете найти полный исходный код того, как это можно сделать с помощью React в репозитории "),n("a",C,[s("js-image-carver"),e(a)]),s(".")])]),M,n("p",null,[s("Изображение, с которым мы работаем, имеет формат "),n("a",I,[s("ImageData"),e(a)]),s(". Это означает, что все пиксели (и их цвета) хранятся в одномерном массиве "),n("a",j,[s("Uint8ClampedArray"),e(a)]),s(". Для удобства чтения введем пару вспомогательных функций, которые позволят работать с массивом Uint8ClampedArray как с "),P,s(" матрицей.")]),A,n("blockquote",null,[n("p",null,[s("Карта энергии будет пересчитываться при каждой итерации изменения размера. Это значит, что она будет пересчитываться, скажем, 500 раз, если нам нужно будет уменьшить изображение на 500 пикселей, что выглядит неоптимально. Чтобы ускорить вычисление карты энергии на 2-м, 3-м и последующих этапах, мы можем пересчитать энергию только для тех пикселей, которые расположены вокруг шва, который будет удален. Для простоты эта оптимизация здесь пропущена, но пример с исходным кодом можно найти в репозитории "),n("a",D,[s("js-image-carver"),e(a)]),s(".")])]),T,n("blockquote",null,[n("p",null,[s("В статье "),n("a",q,[s("Dynamic Programming vs Divide-and-Conquer"),e(a)]),s(' я описывал некоторые аспекты динамического программирования на примере нахождения "расстояния Левенштейна" (преобразование одной строки в другую). Возможно она будет полезна для ознакомления.')])]),G,n("blockquote",null,[n("p",null,[s("Тот факт, что мы повторно используем энергию предыдущего шва для вычисления энергии текущего шва, может быть применен рекурсивно ко всем более коротким швам до самого верхнего 1-го ряда. Когда у нас есть такие перекрывающиеся под-проблемы, "),n("a",B,[s("это признак"),e(a)]),s(", что общая задача "),O,s(" быть оптимизирована с использованием динамического программирования.")])]),J,n("p",null,[s("В настоящее время в функции "),W,s(" мы используем только каналы цветов "),V,s(", "),L,s(", "),U,s(" для вычисления энергии пикселей. Но есть еще и параметр "),X,s(' (альфа, прозрачность), который мы не использовали. Мы можем использовать канал прозрачности, чтобы "сказать" алгоритму, что прозрачные пиксели — это те пиксели, которые мы хотим удалить. Вы можете ознакомиться с '),n("a",F,[s("исходным кодом функции getPixelEnergy()"),e(a)]),s(", которая учитывает прозрачность.")]),Y,H,N,n("p",null,[s("Приложение "),n("a",K,[s("JS IMAGE CARVER"),e(a)]),s(" далеко от идеала и не является приложением production-ready качества. Основной его целью была возможность интерактивного экспериментирования с алгоритмом. Поэтому в дальнейших планах — использовать его именно для экспериментов.")]),n("p",null,[s("В "),n("a",Q,[s("оригинальной статье"),e(a)]),s(" описывается, как алгоритм может быть использован не только для уменьшения, но и для "),Z,s(". Увеличение (расширение) изображения, в свою очередь, может быть использовано для "),$,s(".")]),nn,sn])}const on=p(l,[["render",an],["__file","README.ru-RU.html.vue"]]);export{on as default};
