<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.coding-time.cn/lc/algorithms/image-processing/seam-carving/README.ru-RU.html"><meta property="og:site_name" content="编程时光"><meta property="og:title" content="Изменение размеров изображения с учетом его содержимого в JavaScript"><meta property="og:description" content="Content-aware image resizing in JavaScript Доступна английская интерактивная версия этой статьи (https://trekhleb.dev/blog/2021/content-aware-image-resizing-in-javascript/) в ко..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-07-14T16:27:54.000Z"><meta property="article:author" content="linwu"><meta property="article:modified_time" content="2023-07-14T16:27:54.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Изменение размеров изображения с учетом его содержимого в JavaScript","image":[""],"dateModified":"2023-07-14T16:27:54.000Z","author":[{"@type":"Person","name":"linwu","url":"https://www.coding-time.cn","email":"linwu.hi@gmail.com"}]}</script><meta name="baidu-site-verification" content="codeva-IkQhVRqkxI"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/assets/image/favicon.ico"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/logo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/logo.svg"><meta name="msapplication-TileColor" content="#ffffff"><title>Изменение размеров изображения с учетом его содержимого в JavaScript | 编程时光</title><meta name="description" content="Content-aware image resizing in JavaScript Доступна английская интерактивная версия этой статьи (https://trekhleb.dev/blog/2021/content-aware-image-resizing-in-javascript/) в ко...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-3dcfc125.css" as="style"><link rel="stylesheet" href="/assets/style-3dcfc125.css">
    <link rel="modulepreload" href="/assets/app-d7df62a4.js"><link rel="modulepreload" href="/assets/README.ru-RU.html-e5f66cbc.js"><link rel="modulepreload" href="/assets/README.ru-RU.html-d1b156da.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="vp-brand"><img class="vp-nav-logo" src="/logo.svg" alt="编程时光"><!----><span class="vp-site-name hide-in-pad">编程时光</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a href="/js/preamble.html" class="nav-link" aria-label="现代Javascript高级教程"><span class="font-icon icon iconfont icon-javascript" style=""></span>现代Javascript高级教程<!----></a></div><div class="nav-item hide-in-mobile"><a href="/dart/preamble.html" class="nav-link" aria-label="深入浅出Dart"><span class="font-icon icon iconfont icon-ability" style=""></span>深入浅出Dart<!----></a></div><div class="nav-item hide-in-mobile"><a href="/lc/preamble.html" class="nav-link" aria-label="linwu的算法笔记"><span class="font-icon icon iconfont icon-note" style=""></span>linwu的算法笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/ts/preamble.html" class="nav-link" aria-label="现代Typescript高级教程"><span class="font-icon icon iconfont icon-typescript" style=""></span>现代Typescript高级教程<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://gitee.com/linwu-hi/coding-time-chrome" rel="noopener noreferrer" target="_blank" aria-label="谷歌插件小册" class="nav-link"><!---->谷歌插件小册<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="/md" class="nav-link" aria-label="Markdown编辑器"><!---->Markdown编辑器<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/linwu-hi/coding-time" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a href="/lc/preamble.html" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="序言"><!---->序言<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading clickable"><!----><a href="/lc/data-structures/linked-list" class="nav-link vp-sidebar-title" aria-label="数据结构"><!---->数据结构<!----></a><!----></p><ul class="vp-sidebar-links"><li><!--[--><a href="/lc/data-structures/linked-list" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="链表"><!---->链表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/doubly-linked-list" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="双向链表"><!---->双向链表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/queue" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="队列"><!---->队列<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/stack" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="栈"><!---->栈<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/priority-queue" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="优先队列"><!---->优先队列<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/hash-table" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="哈希表"><!---->哈希表<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/graph" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="图"><!---->图<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/heap" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="堆"><!---->堆<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/lru-cache" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="LRU"><!---->LRU<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/disjoint-set" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="不相交集"><!---->不相交集<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/lc/data-structures/bloom-filter" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="布隆过滤器"><!---->布隆过滤器<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/data-structures/tree/binary-search-tree" class="nav-link vp-sidebar-title" aria-label="树"><!---->树<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><!--[--><a href="/lc/data-structures/trie" class="nav-link vp-sidebar-link vp-sidebar-page" aria-label="字典树"><!---->字典树<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading clickable"><!----><a href="/lc/algorithms/binary-search" class="nav-link vp-sidebar-title" aria-label="算法"><!---->算法<!----></a><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">排序</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">搜索</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">链表</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/algorithms/stack/preamble.html" class="nav-link vp-sidebar-title" aria-label="栈"><!---->栈<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/algorithms/queue/preamble.html" class="nav-link vp-sidebar-title" aria-label="队列"><!---->队列<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/algorithms/two-pointers/preamble.html" class="nav-link vp-sidebar-title" aria-label="双指针"><!---->双指针<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/algorithms/sliding-window/preamble.html" class="nav-link vp-sidebar-title" aria-label="滑动窗口"><!---->滑动窗口<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/algorithms/dynamic-programming/preamble.html" class="nav-link vp-sidebar-title" aria-label="动态规划"><!---->动态规划<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><a href="/lc/algorithms/greedy-algorithm/preamble.html" class="nav-link vp-sidebar-title" aria-label="贪心算法"><!---->贪心算法<!----></a><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">树</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">字符串(可选)</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">图(可选)</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">统计数据(可选)</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Изменение размеров изображения с учетом его содержимого в JavaScript</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://www.coding-time.cn" target="_blank" rel="noopener noreferrer">linwu</a></span><span property="author" content="linwu"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-07-14T16:27:54.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 14 分钟</span><meta property="timeRequired" content="PT14M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#tl-dr" class="router-link-active router-link-exact-active toc-link level2">TL;DR</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#изменение-размеров-изображении-с-учетом-их-содержимого" class="router-link-active router-link-exact-active toc-link level3">Изменение размеров изображений с учетом их содержимого</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#удаление-объектов" class="router-link-active router-link-exact-active toc-link level3">Удаление объектов</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#интерактивныи-ресзаизер" class="router-link-active router-link-exact-active toc-link level3">Интерактивный ресзайзер</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#другие-примеры-ресаиза" class="router-link-active router-link-exact-active toc-link level3">Другие примеры ресайза</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#как-работает-алгоритм-seam-carving" class="router-link-active router-link-exact-active toc-link level2">Как работает алгоритм Seam Carving</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#реализация-алгоритма-на-typescript" class="router-link-active router-link-exact-active toc-link level2">Реализация алгоритма на TypeScript</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#уменьшение-ширины-с-учетом-содержимого-изображения-исходная-функция" class="router-link-active router-link-exact-active toc-link level3">Уменьшение ширины с учетом содержимого изображения (исходная функция)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#расчет-энергии-пикселя" class="router-link-active router-link-exact-active toc-link level3">Расчет энергии пикселя</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#расчет-энергетическои-карты" class="router-link-active router-link-exact-active toc-link level3">Расчет энергетической карты</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#нахождение-шва-с-минимальнои-энергиеи-применяем-динамическое-программирование" class="router-link-active router-link-exact-active toc-link level3">Нахождение шва с минимальной энергией (применяем динамическое программирование)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#удаление-шва-с-минимальнои-энергиеи" class="router-link-active router-link-exact-active toc-link level3">Удаление шва с минимальной энергией</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#удаление-объектов-с-изображения" class="router-link-active router-link-exact-active toc-link level2">Удаление объектов с изображения</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/lc/algorithms/image-processing/seam-carving/README.ru-RU.html#проблемы-алгоритма-и-дальнеишие-планы" class="router-link-active router-link-exact-active toc-link level2">Проблемы алгоритма и дальнейшие планы</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="изменение-размеров-изображения-с-учетом-его-содержимого-в-javascript" tabindex="-1"><a class="header-anchor" href="#изменение-размеров-изображения-с-учетом-его-содержимого-в-javascript" aria-hidden="true">#</a> Изменение размеров изображения с учетом его содержимого в JavaScript</h1><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/01-cover-02.png" alt="Content-aware image resizing in JavaScript" tabindex="0" loading="lazy"><figcaption>Content-aware image resizing in JavaScript</figcaption></figure><blockquote><p>Доступна <a href="https://trekhleb.dev/blog/2021/content-aware-image-resizing-in-javascript/" target="_blank" rel="noopener noreferrer">английская интерактивная версия этой статьи<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> в которой вы можете загрузить свои собственные изображения и посмотреть, как алгоритм &quot;справляется&quot; с ними.</p></blockquote><h2 id="tl-dr" tabindex="-1"><a class="header-anchor" href="#tl-dr" aria-hidden="true">#</a> TL;DR</h2><p>Написано много замечательных статей об алгоритме <em>Seam Carving</em> (&quot;Вырезание швов&quot;), но я не смог устоять перед соблазном самостоятельно исследовать этот элегантный, мощный и в то же время простой алгоритм и написать о своем личном опыте работы с ним. Мое внимание также привлек тот факт, что для его имплементации мы можем применить <em>динамическое программирование (DP)</em>. И, если вы, как и я, все еще находитесь на пути изучения алгоритмов, то это решение может обогатить ваш личный арсенал DP.</p><p>Итак, в этой статье я хочу сделать три вещи:</p><ol><li>Предоставить вам возможность &quot;поиграться&quot; с алгоритмом самостоятельно при помощи <strong>интерактивного ресайзера</strong>.</li><li>Объяснить <strong>идею алгоритма Seam Carving</strong>.</li><li>Объяснить как можно <strong>применить динамическое программирование</strong> для имплементации алгоритма (мы будем писать на TypeScript).</li></ol><h3 id="изменение-размеров-изображении-с-учетом-их-содержимого" tabindex="-1"><a class="header-anchor" href="#изменение-размеров-изображении-с-учетом-их-содержимого" aria-hidden="true">#</a> Изменение размеров изображений с учетом их содержимого</h3><p><em>Изменение размера изображения с учетом содержимого</em> (content-aware image resizing) может быть применено, когда дело доходит до изменения пропорций изображения (например, уменьшения ширины при сохранении высоты), а также когда потеря некоторых частей изображения нежелательна. Простое масштабирование изображения в этом случае исказит находящиеся в нем объекты. Для сохранения пропорций объектов при изменении пропорций изображения можно использовать <a href="https://perso.crans.org/frenoy/matlab2012/seamcarving.pdf" target="_blank" rel="noopener noreferrer">алгоритм Seam Carving<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, который был описан <em>Shai Avidan</em> и <em>Ariel Shamir</em>.</p><p>В приведенном ниже примере показано, как ширина исходного изображения была уменьшена на 50% <em>с учетом содержимого изображения</em> (слева) и <em>без учета содержимого изображения</em> (справа, простой скейлинг). В данном случае левое изображение выглядит более естественным, так как пропорции воздушных шаров в нем были сохранены.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/01-resizing-options.png" alt="Content-aware image resizing" tabindex="0" loading="lazy"><figcaption>Content-aware image resizing</figcaption></figure><p>Идея алгоритма Seam Carving заключается в том, чтобы найти <em>шов</em> (seam, непрерывную последовательность пикселей) с наименьшим влиянием на содержание изображения, а затем его <em>вырезать</em> (carve). Этот процесс повторяется снова и снова, пока мы не получим требуемую ширину или высоту изображения. В примере ниже интуитивно видно, что пиксели воздушных шаров вносят больший &quot;вклад&quot; в содержание и смысл изображения, чем пиксели неба. Таким образом, сначала удаляются пиксели неба.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/10-demo-01.gif" alt="JS IMAGE CARVER DEMO" tabindex="0" loading="lazy"><figcaption>JS IMAGE CARVER DEMO</figcaption></figure><p>Поиск шва с наименьшей энергией (с наименьшим вкладом в содержимое изображения) является вычислительно дорогостоящей операцией (особенно для больших изображений). Для ускорения поиска шва может быть применено <em>динамическое программирование</em> (мы рассмотрим детали реализации ниже).</p><h3 id="удаление-объектов" tabindex="-1"><a class="header-anchor" href="#удаление-объектов" aria-hidden="true">#</a> Удаление объектов</h3><p>Важность каждого пикселя (так называемая энергия пикселя) вычисляется исходя из его цветовой разницы (<code>R</code>, <code>G</code>, <code>B</code>, <code>A</code>) между двумя соседними пикселями. Если же мы вручную зададим некоторым пикселям низкий уровень энергии (например нарисовав маску поверх них), то алгоритм Seam Carving выполнит для нас <strong>удаление помеченного объекта</strong>, как говорится, &quot;забесплатно&quot;.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/10-demo-02.gif" alt="JS IMAGE CARVER OBJECT REMOVAL DEMO" tabindex="0" loading="lazy"><figcaption>JS IMAGE CARVER OBJECT REMOVAL DEMO</figcaption></figure><h3 id="интерактивныи-ресзаизер" tabindex="-1"><a class="header-anchor" href="#интерактивныи-ресзаизер" aria-hidden="true">#</a> Интерактивный ресзайзер</h3><p>Для этой статьи я создал приложение <a href="https://trekhleb.dev/js-image-carver/" target="_blank" rel="noopener noreferrer">JS IMAGE CARVER<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> (доступен также и <a href="https://github.com/trekhleb/js-image-carver" target="_blank" rel="noopener noreferrer">исходный код на GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>), которым вы можете воспользоваться для ресайза своих изображений и увидеть в реальном времени, как работает алгоритм.</p><h3 id="другие-примеры-ресаиза" tabindex="-1"><a class="header-anchor" href="#другие-примеры-ресаиза" aria-hidden="true">#</a> Другие примеры ресайза</h3><p>Вот еще несколько примеров того, как алгоритм справляется с более сложным фоном.</p><p>Горы на заднем плане плавно сжимаются, без видимых швов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/11-demo-01.png" alt="Resizing demo with more complex backgrounds" tabindex="0" loading="lazy"><figcaption>Resizing demo with more complex backgrounds</figcaption></figure><p>То же самое и с океанскими волнами. Алгоритм сохранил волновую структуру, не искажая серферов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/11-demo-02.png" alt="Resizing demo with more complex backgrounds" tabindex="0" loading="lazy"><figcaption>Resizing demo with more complex backgrounds</figcaption></figure><p>Нужно помнить, что алгоритм Seam Carving не является &quot;волшебной таблеткой&quot;, и может не сохранить пропорции важных частей изображения в том случае, когда <em>большая часть пикселей выглядят как края, ребра или границы</em> (почти все пиксели выглядят одинаково важными с точки зрения алгоритма). В приведенном ниже примере изменение размера изображения с учетом содержимого похоже на простое масштабирование, т.к. для алгоритма все пиксели выглядят важными, и ему трудно отличить лицо Ван Гога от фона.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/12-demo-01.png" alt="Example when the algorithm does not work as expected" tabindex="0" loading="lazy"><figcaption>Example when the algorithm does not work as expected</figcaption></figure><h2 id="как-работает-алгоритм-seam-carving" tabindex="-1"><a class="header-anchor" href="#как-работает-алгоритм-seam-carving" aria-hidden="true">#</a> Как работает алгоритм Seam Carving</h2><p>Представим, что у нас есть картинка размером <code>1000 x 500 px</code>, и мы хотим уменьшить ее до <code>500 x 500 px</code> (допустим, квадратное изображение больше подходит для Instagram). В этом случае мы, возможно, захотим задать несколько <strong>требований к процессу изменения размера</strong>:</p><ul><li><em>Важные части изображения должны быть сохранены</em> (если до ресайза на фото было 5 деревьев, то и после ресайза мы хотим увидеть все те же 5 деревьев).</li><li><em>Пропорции важных частей изображения должны быть сохранены</em> (круглые колеса автомобиля не должны стать овальными после ресайза).</li></ul><p>Чтобы избежать изменения важных частей изображения можно найти <strong>непрерывную последовательность пикселей (шов)</strong>, которая будет идти от верхней границы к нижней и иметь <em>наименьший вклад в содержимое</em> изображения (шов, который не проходит через важные части изображения), а затем удалить его. Удаление шва сожмет изображение на один пиксель. Далее надо повторять этот шаг до тех пор, пока изображение не станет нужной ширины.</p><p>Вопрос в том, как определить <em>важность пикселя</em> и его вклад в содержание изображения (в оригинальной статье авторы используют термин <strong>энергия пикселя</strong>). Один из способов это сделать — рассматривать все пиксели, образующие края (границы, ребра), как важные. В случае, если пиксель является частью ребра, его цвет будет отличаться от соседей (левого и правого пикселей).</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/30-pixel-energy-comparison.png" alt="Pixels color difference" tabindex="0" loading="lazy"><figcaption>Pixels color difference</figcaption></figure><p>Предполагая, что цвет пикселя представлен <em>4-мя</em> числами (<code>R</code> - красный, <code>G</code> - зеленый, <code>B</code> - синий, <code>A</code> - альфа, прозрачность), мы можем использовать следующую формулу для вычисления разницы в цвете (энергии пикселя):</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/20-energy-formula.png" alt="Pixel energy formula" tabindex="0" loading="lazy"><figcaption>Pixel energy formula</figcaption></figure><p>Где:</p><ul><li><code>mEnergy</code> - <em>Энергия</em> (важность) <em>среднего</em> пикселя (<code>[0..626]</code> если округлить)</li><li><code>lR</code> - <em>Красный</em> цветовой канал <em>левого</em> пикселя (<code>[0..255]</code>)</li><li><code>mR</code> - <em>Красный</em> цветовой канал <em>среднего</em> пикселя (<code>[0..255]</code>)</li><li><code>rR</code> - <em>Красный</em> цветовой канал <em>правого</em> пикселя (<code>[0..255]</code>)</li><li><code>lG</code> - <em>Зеленый</em> цветовой канал <em>левого</em> пикселя (<code>[0..255]</code>)</li><li>и так далее...</li></ul><p>В приведенной выше формуле мы пока не используем альфа-канал (прозрачность), предполагая, что изображение не содержит прозрачные пиксели. Позже мы будем использовать альфа-канал для маскировки и удаления объектов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/30-pixel-energy-calculation-example.png" alt="Example of pixel energy calculation" tabindex="0" loading="lazy"><figcaption>Example of pixel energy calculation</figcaption></figure><p>Поскольку мы знаем, как найти энергию одного пикселя, мы можем вычислить так называемую <strong>энергетическую карту</strong>, которая будет содержать энергии каждого пикселя изображения. На каждом шаге изменения размера изображения карту энергий необходимо пересчитывать (по крайней мере частично, подробнее об этом ниже), и она будет иметь тот же размер, что и изображение.</p><p>Например, на 1-м шаге у нас будет изображение размером <code>1000 x 500</code> и энергетическая карта размером <code>1000 x 500</code>. На 2-м шаге изменения размера мы удалим шов с изображения и пересчитаем карту энергий на основе нового уменьшенного изображения. Таким образом, мы получим изображение размером <code>999 x 500</code> и карту энергий размером <code>999 x 500</code>.</p><p>Чем выше энергия пикселя, тем больше вероятность того, что он является частью ребра, важен для содержимого изображения и тем меньше вероятность того, что нам потребуется его удалить.</p><p>Для визуализации карты энергий мы можем присвоить более яркий цвет пикселям с большей энергией и более темные цвета пикселям с меньшей энергией. Вот как может выглядеть часть карты энергий. Вы можете увидеть светлую линию, которая представляет край и которую мы хотим сохранить при изменении размера.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/30-energy-map-padding.png" alt="Energy map sketch" tabindex="0" loading="lazy"><figcaption>Energy map sketch</figcaption></figure><p>Вот реальный пример энергетической карты для изображения, которое вы видели выше (с воздушными шарами).</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/40-energy-map.png" alt="Energy map example" tabindex="0" loading="lazy"><figcaption>Energy map example</figcaption></figure><p>Вы можете загрузить свое изображение и посмотреть, как будет выглядеть энергетическая карта в <a href="https://trekhleb.dev/blog/2021/content-aware-image-resizing-in-javascript/" target="_blank" rel="noopener noreferrer">интерактивной версии статьи<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><p>Мы можем использовать энергетическую карту, чтобы найти швы (один за другим) с наименьшей энергией и тем самым решить, какие пиксели в конечном итоге должны быть удалены.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/41-seam-search.png" alt="Searching the seam" tabindex="0" loading="lazy"><figcaption>Searching the seam</figcaption></figure><p>Поиск шва с наименьшими затратами энергии не является тривиальной задачей и требует перебора множества возможных комбинаций пикселей. Мы применим динамическое программирование для оптимизации поиска шва.</p><p>В примере ниже вы можете увидеть карту энергий с первым найденным для нее швом с наименьшей энергией.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/40-energy-map-with-seam.png" alt="Energy map example with seam" tabindex="0" loading="lazy"><figcaption>Energy map example with seam</figcaption></figure><p>В приведенных выше примерах мы уменьшали ширину изображения. Аналогичный подход может быть использован для уменьшения высоты изображения. Для этого нам нужно:</p><ul><li>начать использовать соседей <em>сверху</em> и <em>снизу</em>, а не <em>слева</em> и <em>справа</em>, для вычисления энергии пикселя</li><li>при поиске шва нам нужно двигаться <em>слева</em> <em>направо</em>, а не <em>сверху</em> <em>вниз</em>.</li></ul><h2 id="реализация-алгоритма-на-typescript" tabindex="-1"><a class="header-anchor" href="#реализация-алгоритма-на-typescript" aria-hidden="true">#</a> Реализация алгоритма на TypeScript</h2><blockquote><p>Исходный код и функции, упомянутые ниже, можно найти в репозитории <a href="https://github.com/trekhleb/js-image-carver" target="_blank" rel="noopener noreferrer">js-image-carver<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p></blockquote><p>Для реализации алгоритма мы будем использовать TypeScript. Если вам нужна версия на JavaScript, вы можете игнорировать (удалить) определения типов и их использование.</p><p>Для простоты примеров мы напишем код только для уменьшения <em>ширины</em> изображения.</p><h3 id="уменьшение-ширины-с-учетом-содержимого-изображения-исходная-функция" tabindex="-1"><a class="header-anchor" href="#уменьшение-ширины-с-учетом-содержимого-изображения-исходная-функция" aria-hidden="true">#</a> Уменьшение ширины с учетом содержимого изображения (исходная функция)</h3><p>Для начала определим некоторые общие типы, которые мы будем использовать при реализации алгоритма.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Type that describes the image size (width and height).</span>
<span class="token keyword">type</span> <span class="token class-name">ImageSize</span> <span class="token operator">=</span> <span class="token punctuation">{</span> w<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> h<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The coordinate of the pixel.</span>
<span class="token keyword">type</span> <span class="token class-name">Coordinate</span> <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The seam is a sequence of pixels (coordinates).</span>
<span class="token keyword">type</span> <span class="token class-name">Seam</span> <span class="token operator">=</span> Coordinate<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Energy map is a 2D array that has the same width and height</span>
<span class="token comment">// as the image the map is being calculated for.</span>
<span class="token keyword">type</span> <span class="token class-name">EnergyMap</span> <span class="token operator">=</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Type that describes the image pixel&#39;s RGBA color.</span>
<span class="token keyword">type</span> <span class="token class-name">Color</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  r<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Red</span>
  g<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Green</span>
  b<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Blue</span>
  a<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Alpha (transparency)</span>
<span class="token punctuation">]</span> <span class="token operator">|</span> Uint8ClampedArray<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Для имплементации алгоритма нам необходимо выполнить следующие шаги:</p><ol><li>Рассчитать <strong>карту энергии</strong> для текущей версии изображения.</li><li>Найти <strong>шов</strong> с наименьшей энергией на основе карты энергий (здесь мы применим динамическое программирование).</li><li><strong>Удалить шов</strong> с наименьшей энергией из изображения.</li><li><strong>Повторять</strong> до тех пор, пока ширина изображения не будет уменьшена до нужного значения.</li></ol><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">ResizeImageWidthArgs</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token comment">// Image data we want to resize.</span>
  toWidth<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// Final image width we want the image to shrink to.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">type</span> <span class="token class-name">ResizeImageWidthResult</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token comment">// Resized image data.</span>
  size<span class="token operator">:</span> ImageSize<span class="token punctuation">,</span> <span class="token comment">// Resized image size (w x h).</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Performs the content-aware image width resizing using the seam carving method.</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> resizeImageWidth <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token punctuation">{</span> img<span class="token punctuation">,</span> toWidth <span class="token punctuation">}</span><span class="token operator">:</span> ResizeImageWidthArgs<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ResizeImageWidthResult <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// For performance reasons we want to avoid changing the img data array size.</span>
  <span class="token comment">// Instead we&#39;ll just keep the record of the resized image width and height separately.</span>
  <span class="token keyword">const</span> size<span class="token operator">:</span> ImageSize <span class="token operator">=</span> <span class="token punctuation">{</span> w<span class="token operator">:</span> img<span class="token punctuation">.</span>width<span class="token punctuation">,</span> h<span class="token operator">:</span> img<span class="token punctuation">.</span>height <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Calculating the number of pixels to remove.</span>
  <span class="token keyword">const</span> pxToRemove <span class="token operator">=</span> img<span class="token punctuation">.</span>width <span class="token operator">-</span> toWidth<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pxToRemove <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Upsizing is not supported for now&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> energyMap<span class="token operator">:</span> EnergyMap <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> seam<span class="token operator">:</span> Seam <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// Removing the lowest energy seams one by one.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pxToRemove<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Calculate the energy map for the current version of the image.</span>
    energyMap <span class="token operator">=</span> <span class="token function">calculateEnergyMap</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. Find the seam with the lowest energy based on the energy map.</span>
    seam <span class="token operator">=</span> <span class="token function">findLowEnergySeam</span><span class="token punctuation">(</span>energyMap<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. Delete the seam with the lowest energy seam from the image.</span>
    <span class="token function">deleteSeam</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> seam<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Reduce the image width, and continue iterations.</span>
    size<span class="token punctuation">.</span>w <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Returning the resized image and its final size.</span>
  <span class="token comment">// The img is actually a reference to the ImageData, so technically</span>
  <span class="token comment">// the caller of the function already has this pointer. But let&#39;s</span>
  <span class="token comment">// still return it for better code readability.</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> img<span class="token punctuation">,</span> size <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Изображение, которому необходимо изменить размер, передается в функцию в формате <a href="https://developer.mozilla.org/en-US/docs/Web/API/ImageData" target="_blank" rel="noopener noreferrer">ImageData<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. Вы можете отобразить изображение на canvas-е, а затем извлечь ImageData из того же canvas-а следующим образом:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&#39;2d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imgData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> imgWidth<span class="token punctuation">,</span> imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Загрузка и отрисовка изображений в JavaScript выходит за рамки данной статьи, но вы можете найти полный исходный код того, как это можно сделать с помощью React в репозитории <a href="https://github.com/trekhleb/js-image-carver" target="_blank" rel="noopener noreferrer">js-image-carver<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p></blockquote><p>Теперь, пошагово реализуем функции <code>calculateEnergyMap()</code>, <code>findLowEnergySeam()</code> и <code>deleteSeam()</code>.</p><h3 id="расчет-энергии-пикселя" tabindex="-1"><a class="header-anchor" href="#расчет-энергии-пикселя" aria-hidden="true">#</a> Расчет энергии пикселя</h3><p>Для расчета воспользуемся формулой разницы цветов, описанной выше. Для левой и правой краев изображения (когда нет левого или правого соседей) мы игнорируем соседей и не учитываем их при расчете энергии.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Calculates the energy of a pixel.</span>
<span class="token keyword">const</span> getPixelEnergy <span class="token operator">=</span> <span class="token punctuation">(</span>left<span class="token operator">:</span> Color <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> middle<span class="token operator">:</span> Color<span class="token punctuation">,</span> right<span class="token operator">:</span> Color <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Middle pixel is the pixel we&#39;re calculating the energy for.</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>mR<span class="token punctuation">,</span> mG<span class="token punctuation">,</span> mB<span class="token punctuation">]</span> <span class="token operator">=</span> middle<span class="token punctuation">;</span>

  <span class="token comment">// Energy from the left pixel (if it exists).</span>
  <span class="token keyword">let</span> lEnergy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>lR<span class="token punctuation">,</span> lG<span class="token punctuation">,</span> lB<span class="token punctuation">]</span> <span class="token operator">=</span> left<span class="token punctuation">;</span>
    lEnergy <span class="token operator">=</span> <span class="token punctuation">(</span>lR <span class="token operator">-</span> mR<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>lG <span class="token operator">-</span> mG<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>lB <span class="token operator">-</span> mB<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Energy from the right pixel (if it exists).</span>
  <span class="token keyword">let</span> rEnergy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>rR<span class="token punctuation">,</span> rG<span class="token punctuation">,</span> rB<span class="token punctuation">]</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
    rEnergy <span class="token operator">=</span> <span class="token punctuation">(</span>rR <span class="token operator">-</span> mR<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rG <span class="token operator">-</span> mG<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>rB <span class="token operator">-</span> mB<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Resulting pixel energy.</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>lEnergy <span class="token operator">+</span> rEnergy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="расчет-энергетическои-карты" tabindex="-1"><a class="header-anchor" href="#расчет-энергетическои-карты" aria-hidden="true">#</a> Расчет энергетической карты</h3><p>Изображение, с которым мы работаем, имеет формат <a href="https://developer.mozilla.org/en-US/docs/Web/API/ImageData" target="_blank" rel="noopener noreferrer">ImageData<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. Это означает, что все пиксели (и их цвета) хранятся в одномерном массиве <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8ClampedArray" target="_blank" rel="noopener noreferrer">Uint8ClampedArray<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. Для удобства чтения введем пару вспомогательных функций, которые позволят работать с массивом Uint8ClampedArray как с <em>2D</em> матрицей.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Helper function that returns the color of the pixel.</span>
<span class="token keyword">const</span> getPixel <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token operator">:</span> Coordinate<span class="token punctuation">)</span><span class="token operator">:</span> Color <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The ImageData data array is a flat 1D array.</span>
  <span class="token comment">// Thus we need to convert x and y coordinates to the linear index.</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> y <span class="token operator">*</span> img<span class="token punctuation">.</span>width <span class="token operator">+</span> x<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cellsPerColor <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// RGBA</span>
  <span class="token comment">// For better efficiency, instead of creating a new sub-array we return</span>
  <span class="token comment">// a pointer to the part of the ImageData array.</span>
  <span class="token keyword">return</span> img<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span>i <span class="token operator">*</span> cellsPerColor<span class="token punctuation">,</span> i <span class="token operator">*</span> cellsPerColor <span class="token operator">+</span> cellsPerColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Helper function that sets the color of the pixel.</span>
<span class="token keyword">const</span> setPixel <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token operator">:</span> Coordinate<span class="token punctuation">,</span> color<span class="token operator">:</span> Color<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The ImageData data array is a flat 1D array.</span>
  <span class="token comment">// Thus we need to convert x and y coordinates to the linear index.</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> y <span class="token operator">*</span> img<span class="token punctuation">.</span>width <span class="token operator">+</span> x<span class="token punctuation">;</span>
  <span class="token keyword">const</span> cellsPerColor <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// RGBA</span>
  img<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> i <span class="token operator">*</span> cellsPerColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Для вычисления карты энергии мы проходим через каждый пиксель изображения и вызываем для него описанную ранее функцию <code>getPixelEnergy()</code>.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Helper function that creates a matrix (2D array) of specific</span>
<span class="token comment">// size (w x h) and fills it with specified value.</span>
<span class="token keyword">const</span> matrix <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>w<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> h<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> filler<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>filler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Calculates the energy of each pixel of the image.</span>
<span class="token keyword">const</span> calculateEnergyMap <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> <span class="token punctuation">{</span> w<span class="token punctuation">,</span> h <span class="token punctuation">}</span><span class="token operator">:</span> ImageSize<span class="token punctuation">)</span><span class="token operator">:</span> EnergyMap <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create an empty energy map where each pixel has infinitely high energy.</span>
  <span class="token comment">// We will update the energy of each pixel.</span>
  <span class="token keyword">const</span> energyMap<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">matrix</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> h<span class="token punctuation">;</span> y <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Left pixel might not exist if we&#39;re on the very left edge of the image.</span>
      <span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// The color of the middle pixel that we&#39;re calculating the energy for.</span>
      <span class="token keyword">const</span> middle <span class="token operator">=</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Right pixel might not exist if we&#39;re on the very right edge of the image.</span>
      <span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> w <span class="token operator">?</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      energyMap<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getPixelEnergy</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> middle<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> energyMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Карта энергии будет пересчитываться при каждой итерации изменения размера. Это значит, что она будет пересчитываться, скажем, 500 раз, если нам нужно будет уменьшить изображение на 500 пикселей, что выглядит неоптимально. Чтобы ускорить вычисление карты энергии на 2-м, 3-м и последующих этапах, мы можем пересчитать энергию только для тех пикселей, которые расположены вокруг шва, который будет удален. Для простоты эта оптимизация здесь пропущена, но пример с исходным кодом можно найти в репозитории <a href="https://github.com/trekhleb/js-image-carver" target="_blank" rel="noopener noreferrer">js-image-carver<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p></blockquote><h3 id="нахождение-шва-с-минимальнои-энергиеи-применяем-динамическое-программирование" tabindex="-1"><a class="header-anchor" href="#нахождение-шва-с-минимальнои-энергиеи-применяем-динамическое-программирование" aria-hidden="true">#</a> Нахождение шва с минимальной энергией (применяем динамическое программирование)</h3><blockquote><p>В статье <a href="https://trekhleb.dev/blog/2018/dynamic-programming-vs-divide-and-conquer/" target="_blank" rel="noopener noreferrer">Dynamic Programming vs Divide-and-Conquer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> я описывал некоторые аспекты динамического программирования на примере нахождения &quot;расстояния Левенштейна&quot; (преобразование одной строки в другую). Возможно она будет полезна для ознакомления.</p></blockquote><p>Проблема, которую нам необходимо решить заключается в нахождении пути (шва) на энергетической карте, который идет от верхней границы изображения к нижней и имеет минимальную энергию (сумма энергий пикселей, составляющих шов должна быть минимальной).</p><h4 id="наивныи-подход-naive" tabindex="-1"><a class="header-anchor" href="#наивныи-подход-naive" aria-hidden="true">#</a> &quot;Наивный&quot; подход (naive)</h4><p>Прямолинейный (&quot;наивный&quot;) подход — перебрать все возможные пути один за другим.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/50-naive-approach.png" alt="The naive approach" tabindex="0" loading="lazy"><figcaption>The naive approach</figcaption></figure><p>Двигаясь сверху вниз, для каждого пикселя у нас есть 3 варианта (↙︎ идти вниз-влево, ↓ вниз, ↘︎ идти вниз-вправо). Это дает нам временную сложность <code>O (w * 3 ^ h)</code> или просто <code>O (3 ^ h)</code>, где <code>w</code> и<code> h</code> - ширина и высота изображения. Такой подход выглядит неоптимальным.</p><h4 id="жадныи-подход-greedy" tabindex="-1"><a class="header-anchor" href="#жадныи-подход-greedy" aria-hidden="true">#</a> &quot;Жадный&quot; подход (greedy)</h4><p>Жадный подход — выбирать следующий пиксель как пиксель с наименьшей энергией, надеясь, что результирующая энергия шва будет наименьшей.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/51-greedy-approach.png" alt="The greedy approach" tabindex="0" loading="lazy"><figcaption>The greedy approach</figcaption></figure><p>Жадный подход приведет нас к не самому худшему решению, но он не сможет гарантировать, что мы найдем наилучшее доступное решение. На картинке выше видно, как мы выбрали <code>5</code> вместо <code>10</code> и пропустили цепочку оптимальных пикселей.</p><p>Плюс этого подхода в том, что он быстрый и имеет временную сложность <code>O(w + h)</code>, где <code>w</code> и <code>h</code> - это ширина и высота изображения. В этом случае плата за скорость — низкое качество ресайза (много искажений). Временная сложность обусловлена тем, что нужно найти минимальное значение в первом ряду (обход <code>w</code> ячеек), а затем исследовать только 3 соседних пикселя для каждого ряда (обход <code>h</code> рядов).</p><h4 id="используем-динамическое-программирование" tabindex="-1"><a class="header-anchor" href="#используем-динамическое-программирование" aria-hidden="true">#</a> Используем динамическое программирование</h4><p>Вы, наверное, заметили, что в наивном подходе мы снова и снова суммировали одни и те же энергии пикселей, вычисляя энергию образовавшихся швов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/52-dp-repeated-problems.png" alt="Repeated problems" tabindex="0" loading="lazy"><figcaption>Repeated problems</figcaption></figure><p>В примере выше видно, что для первых двух швов мы повторно используем энергию более короткого шва (который имеет энергию <code>235</code>). Вместо одной операции <code>235 + 70</code> для вычисления энергии 2-го шва мы делаем четыре операции <code>(5 + 0 + 80 + 150) + 70</code>.</p><blockquote><p>Тот факт, что мы повторно используем энергию предыдущего шва для вычисления энергии текущего шва, может быть применен рекурсивно ко всем более коротким швам до самого верхнего 1-го ряда. Когда у нас есть такие перекрывающиеся под-проблемы, <a href="https://trekhleb.dev/blog/2018/dynamic-programming-vs-divide-and-conquer/" target="_blank" rel="noopener noreferrer">это признак<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, что общая задача <em>может</em> быть оптимизирована с использованием динамического программирования.</p></blockquote><p>Таким образом, мы можем <strong>сохранить энергию текущего шва</strong> для конкретного пикселя в дополнительной таблице <code>samsEnergies</code>, чтобы повторно использовать ее при расчете энергии следующих швов (таблица <code>samsEnergies</code> будет иметь тот же размер, что и энергетическая карта и само изображение).</p><p>Обратите также внимание, что для большинства пикселей в изображении (например, для левого нижнего) мы можем иметь <em>несколько</em> значений энергий предыдущих швов.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/53-dp-what-to-choose.png" alt="What seam to choose" tabindex="0" loading="lazy"><figcaption>What seam to choose</figcaption></figure><p>Так как мы ищем шов с наименьшей результирующей энергией, имеет смысл выбирать и предыдущий шов с наименьшей результирующей энергией.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/56-dp-seams-energies-example.png" alt="Seams energies example" tabindex="0" loading="lazy"><figcaption>Seams energies example</figcaption></figure><p>Как правило, у нас есть три возможных предыдущих шва, которые текущий пиксель продолжает:</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/55-dp-three-options.png" alt="Three options to choose from" tabindex="0" loading="lazy"><figcaption>Three options to choose from</figcaption></figure><p>Можем посмотреть на это с такой стороны:</p><ul><li>Ячейка <code>[1][x]</code>: содержит наименьшую возможную энергию шва, который начинается где-то в ряду <code>[0][?] </code> и заканчивается в ячейке <code>[1][x]</code>.</li><li><strong>Текущая ячейка</strong> <code>[2][3]</code>: содержит наименьшую возможную энергию шва, который начинается где-то в ряду <code>[0][?] </code> и заканчивается в ячейке <code>[2][3]</code>. Для вычисления нужно суммировать энергию текущего пикселя <code>[2][3]</code> (из энергетической карты) с <code>min(seam_energy_1_2, seam_energy_1_3, seam_energy_1_4)</code>.</li></ul><p>Если мы заполним таблицу <code>ShesamsEnergies</code> полностью, то минимальное число в нижнем ряду будет наименьшей возможной энергией шва.</p><p>Попробуем заполнить несколько ячеек этой таблицы, чтобы посмотреть, как это работает.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/57-dp-seams-energies-traversal.png" alt="Seams energies map traversal" tabindex="0" loading="lazy"><figcaption>Seams energies map traversal</figcaption></figure><p>После заполнения таблицы <code>ShesamsEnergies</code> видно, что в нижнем ряду пиксель с самой низкой энергией имеет значение <code>50</code>. Для удобства во время генерации <code>samsEnergies</code> для каждого пикселя мы можем сохранить не только энергию шва, но и координаты предыдущего шва с наименьшей энергией. Это даст нам возможность легко восстанавливать траекторию шва снизу вверх.</p><p>Временная сложность DP подхода составит <code>O(w * h)</code>, где <code>w</code> и <code>h</code> - это ширина и высота изображения. Обусловлена она тем, что нужно вычислить энергии для <em>всех</em> пикселей изображения.</p><p>Вот пример того, как эта логика может быть реализована:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// The metadata for the pixels in the seam.</span>
<span class="token keyword">type</span> <span class="token class-name">SeamPixelMeta</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  energy<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token comment">// The energy of the pixel.</span>
  coordinate<span class="token operator">:</span> Coordinate<span class="token punctuation">,</span> <span class="token comment">// The coordinate of the pixel.</span>
  previous<span class="token operator">:</span> Coordinate <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// The previous pixel in a seam.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Finds the seam (the sequence of pixels from top to bottom) that has the</span>
<span class="token comment">// lowest resulting energy using the Dynamic Programming approach.</span>
<span class="token keyword">const</span> findLowEnergySeam <span class="token operator">=</span> <span class="token punctuation">(</span>energyMap<span class="token operator">:</span> EnergyMap<span class="token punctuation">,</span> <span class="token punctuation">{</span> w<span class="token punctuation">,</span> h <span class="token punctuation">}</span><span class="token operator">:</span> ImageSize<span class="token punctuation">)</span><span class="token operator">:</span> Seam <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// The 2D array of the size of w and h, where each pixel contains the</span>
  <span class="token comment">// seam metadata (pixel energy, pixel coordinate and previous pixel from</span>
  <span class="token comment">// the lowest energy seam at this point).</span>
  <span class="token keyword">const</span> seamsEnergies<span class="token operator">:</span> <span class="token punctuation">(</span>SeamPixelMeta <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">matrix</span><span class="token generic class-name"><span class="token operator">&lt;</span>SeamPixelMeta <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Populate the first row of the map by just copying the energies</span>
  <span class="token comment">// from the energy map.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      energy<span class="token operator">:</span> energyMap<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>
      coordinate<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">,</span>
      previous<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Populate the rest of the rows.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> h<span class="token punctuation">;</span> y <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Find the top adjacent cell with minimum energy.</span>
      <span class="token comment">// This cell would be the tail of a seam with lowest energy at this point.</span>
      <span class="token comment">// It doesn&#39;t mean that this seam (path) has lowest energy globally.</span>
      <span class="token comment">// Instead, it means that we found a path with the lowest energy that may lead</span>
      <span class="token comment">// us to the current pixel with the coordinates x and y.</span>
      <span class="token keyword">let</span> minPrevEnergy <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> minPrevX<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> w <span class="token operator">&amp;&amp;</span> seamsEnergies<span class="token punctuation">[</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>energy <span class="token operator">&lt;</span> minPrevEnergy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          minPrevEnergy <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>energy<span class="token punctuation">;</span>
          minPrevX <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Update the current cell.</span>
      seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        energy<span class="token operator">:</span> minPrevEnergy <span class="token operator">+</span> energyMap<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>
        coordinate<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">,</span>
        previous<span class="token operator">:</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> minPrevX<span class="token punctuation">,</span> y<span class="token operator">:</span> y <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Find where the minimum energy seam ends.</span>
  <span class="token comment">// We need to find the tail of the lowest energy seam to start</span>
  <span class="token comment">// traversing it from its tail to its head (from the bottom to the top).</span>
  <span class="token keyword">let</span> lastMinCoordinate<span class="token operator">:</span> Coordinate <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> minSeamEnergy <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> w<span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> y <span class="token operator">=</span> h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>energy <span class="token operator">&lt;</span> minSeamEnergy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      minSeamEnergy <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>energy<span class="token punctuation">;</span>
      lastMinCoordinate <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Find the lowest energy energy seam.</span>
  <span class="token comment">// Once we know where the tail is we may traverse and assemble the lowest</span>
  <span class="token comment">// energy seam based on the &quot;previous&quot; value of the seam pixel metadata.</span>
  <span class="token keyword">const</span> seam<span class="token operator">:</span> Seam <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastMinCoordinate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> seam<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> lastMinX<span class="token punctuation">,</span> y<span class="token operator">:</span> lastMinY <span class="token punctuation">}</span> <span class="token operator">=</span> lastMinCoordinate<span class="token punctuation">;</span>

  <span class="token comment">// Adding new pixel to the seam path one by one until we reach the top.</span>
  <span class="token keyword">let</span> currentSeam <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>lastMinY<span class="token punctuation">]</span><span class="token punctuation">[</span>lastMinX<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentSeam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    seam<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentSeam<span class="token punctuation">.</span>coordinate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevMinCoordinates <span class="token operator">=</span> currentSeam<span class="token punctuation">.</span>previous<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevMinCoordinates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentSeam <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> prevMinX<span class="token punctuation">,</span> y<span class="token operator">:</span> prevMinY <span class="token punctuation">}</span> <span class="token operator">=</span> prevMinCoordinates<span class="token punctuation">;</span>
      currentSeam <span class="token operator">=</span> seamsEnergies<span class="token punctuation">[</span>prevMinY<span class="token punctuation">]</span><span class="token punctuation">[</span>prevMinX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> seam<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="удаление-шва-с-минимальнои-энергиеи" tabindex="-1"><a class="header-anchor" href="#удаление-шва-с-минимальнои-энергиеи" aria-hidden="true">#</a> Удаление шва с минимальной энергией</h3><p>Как только мы нашли шов с наименьшей суммарной энергией, нам нужно удалить (вырезать) пиксели, которые образуют его из изображения. Удаление происходит путем смещения пикселей справа от шва на <code>1px</code> влево. Из соображений производительности мы не будем удалять крайний столбик пикселей. Вместо этого, компонент, отвечающий за отрисовку уменьшенного изображения просто проигнорирует ту часть изображения, которая лежит за пределами обрезанной ширины.</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/60-deleting-example.png" alt="Deleting the seam" tabindex="0" loading="lazy"><figcaption>Deleting the seam</figcaption></figure><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// Deletes the seam from the image data.</span>
<span class="token comment">// We delete the pixel in each row and then shift the rest of the row pixels to the left.</span>
<span class="token keyword">const</span> deleteSeam <span class="token operator">=</span> <span class="token punctuation">(</span>img<span class="token operator">:</span> ImageData<span class="token punctuation">,</span> seam<span class="token operator">:</span> Seam<span class="token punctuation">,</span> <span class="token punctuation">{</span> w <span class="token punctuation">}</span><span class="token operator">:</span> ImageSize<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  seam<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> seamX<span class="token punctuation">,</span> y<span class="token operator">:</span> seamY <span class="token punctuation">}</span><span class="token operator">:</span> Coordinate<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> seamX<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token punctuation">(</span>w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> nextPixel <span class="token operator">=</span> <span class="token function">getPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span> seamY <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setPixel</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token operator">:</span> seamY <span class="token punctuation">}</span><span class="token punctuation">,</span> nextPixel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="удаление-объектов-с-изображения" tabindex="-1"><a class="header-anchor" href="#удаление-объектов-с-изображения" aria-hidden="true">#</a> Удаление объектов с изображения</h2><p>Seam Carving алгоритм пытается сначала удалить швы, состоящие из низкоэнергетических пикселей. Мы могли бы использовать этот факт и, присвоив низкую энергию некоторым пикселям вручную (например, нарисовав на изображении маску), мы могли бы заставить алгоритм удалить отмеченные пиксели (<em>объекты</em>).</p><p>В настоящее время в функции <code>getPixelEnergy()</code> мы используем только каналы цветов <code>R</code>, <code>G</code>, <code>B</code> для вычисления энергии пикселей. Но есть еще и параметр <code>A</code> (альфа, прозрачность), который мы не использовали. Мы можем использовать канал прозрачности, чтобы &quot;сказать&quot; алгоритму, что прозрачные пиксели — это те пиксели, которые мы хотим удалить. Вы можете ознакомиться с <a href="https://github.com/trekhleb/js-image-carver/blob/main/src/utils/contentAwareResizer.ts#L54" target="_blank" rel="noopener noreferrer">исходным кодом функции getPixelEnergy()<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, которая учитывает прозрачность.</p><p>Вот как при этом будет выглядеть удаление объектов:</p><figure><img src="https://raw.githubusercontent.com/trekhleb/trekhleb.github.io/master/src/posts/2021/content-aware-image-resizing-in-javascript/assets/10-demo-02.gif" alt="JS IMAGE CARVER OBJECT REMOVAL DEMO" tabindex="0" loading="lazy"><figcaption>JS IMAGE CARVER OBJECT REMOVAL DEMO</figcaption></figure><h2 id="проблемы-алгоритма-и-дальнеишие-планы" tabindex="-1"><a class="header-anchor" href="#проблемы-алгоритма-и-дальнеишие-планы" aria-hidden="true">#</a> Проблемы алгоритма и дальнейшие планы</h2><p>Приложение <a href="https://github.com/trekhleb/js-image-carver" target="_blank" rel="noopener noreferrer">JS IMAGE CARVER<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> далеко от идеала и не является приложением production-ready качества. Основной его целью была возможность интерактивного экспериментирования с алгоритмом. Поэтому в дальнейших планах — использовать его именно для экспериментов.</p><p>В <a href="https://perso.crans.org/frenoy/matlab2012/seamcarving.pdf" target="_blank" rel="noopener noreferrer">оригинальной статье<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> описывается, как алгоритм может быть использован не только для уменьшения, но и для <strong>увеличения изображения</strong>. Увеличение (расширение) изображения, в свою очередь, может быть использовано для <strong>автоматического расширения изображения до его исходной ширины после удаления объектов</strong>.</p><p>Еще одной интересной областью экспериментов может быть попытка ускорить алгоритм, чтобы он работал в режиме <strong>реального времени</strong>.</p><blockquote><p>Таковы планы на будущее, но пока, надеюсь, пример с уменьшением изображения был интересен и полезен для вас. Также надеюсь, что вам было интересно увидеть применение динамического программирования в задачах, приближенных к реальности.</p><p>Удачи с вашими собственными экспериментами!</p></blockquote></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/linwu-hi/coding-time/edit/main/docs/lc/algorithms/image-processing/seam-carving/README.ru-RU.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: linwu.hi@gmail.com">linwu-hi</span><!--]--><!--]--></div></div></footer><!----><div id="comment" class="giscus-wrapper input-top" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><!----></div><!--]--><!----><!----><div class="qrcode-ui" data-v-85ffe88e><div class="qrcode-container" data-v-85ffe88e><div class="tencent-code" data-v-85ffe88e><h4 data-v-85ffe88e>关注公众号</h4><p data-v-85ffe88e>和小伙伴们一起学习</p> <img src="/assets/gzh.jpg" alt="" data-v-85ffe88e></div><div class="group_code" data-v-85ffe88e><h4 data-v-85ffe88e>加入技术交流群</h4><p data-v-85ffe88e>扫描二维码 备注<span data-v-85ffe88e>加群</span></p><img class="wx" src="/assets/wx.jpg" alt="" data-v-85ffe88e></div></div></div><!--]--></div>
    <script type="module" src="/assets/app-d7df62a4.js" defer></script>
  </body>
</html>
